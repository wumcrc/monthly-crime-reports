---
title: "Forest Park Southeast, Botanical Heights, Central West End, Medical Campus"
subtitle: "Monthly Crime report: August 2020" 
author: "Washington University Medical Center"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output:
  powerpoint_presentation
always_allow_html: yes
params:
  month: December
  year: 2020
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Dependencies and Data, include = FALSE}
# tidyverse packages
library(ggplot2)       # plotting data
library(stringr)       # wrappers for common string operations
library(tidyr)         # tidy data
library(dplyr)         # data manipulation
library(magrittr)      # pipe operator
library(readxl)        # read & write excel files
library(lubridate)     # time data manipulation
library(scales)

# spatial packages
library(tmap)         # map layouts
library(tmaptools)    # tools for handeling spatial
library(oldtmaptools) # deprecated toolds for spatial analysis
library(sf)           # spatial data tools
library(ceramic)      # download online imagery tiles
library(compstatr)    # tools for STL crime data
library(raster)       # geograpic data analysis & modeling

# other packages
library(here)         # file path management
library(janitor)      # tools for examining data
library(RColorBrewer) # cynthia brewer color palettes
library(viridis)      # color palettes
library(flextable)   # exporting pretty tables
library(htmltools)
library(knitr)
library(tibble)
library(rlang)
library(officer)      # powerpoint output
#devtools::install_github("davidgohel/officer")   # use github version until updates are made to CRAN
library(customLayout) # custom powerpoint layout
library(docxtractr)   #convert pptx to pdf
library(qwraps2)


# load data
load(file = here("data", "basemap-files", "mapbox-tiles.rda"))
load(file = here("data", "basemap-files", "boundaries.rda"))
load(file = here("data", "crime-data.rda"))
load(file = here("data", "spatial-crime-data.rda"))
load(file = here("data", "nbhd_pop10.rda"))
load(file = here("data", "basemap-files", "nbhd-boundaries.rda"))

# create powerpoint
report <- read_pptx()
```

#Function References

`lay_new` creates a custom layout. You use the `matrix` argument to specify the location of figures.

`lay_bind_row` combines custom layouts. In this instance, we are combining the title layout with the body layout for our powerpoint slide.

`phl_layout` transforms your custom layout to an officer PowerPoint slide.

`fp_text` creates a font style for an officer powerpoint slide.

`ftext` creates a formatted chunk of text, often referencing `fp_text` for formatting instructions.

`fpar` creates formatted paragraphs in Powerpoint. Used to concatenate `ftext` objects into a paragraph.

`block_list` combines several blocks, or `fpar` objects, into a single object. Used to create formatted paragraphs in Powerpoint.

`read_pptx` creates a powerpoint presentation. You can use a variety of functions to add content to the presentation once the object is created.

`add_slide` adds a powerpoint slide to an existing powerpoint object. Specify what kind of layout you want the slide to be.

`ph_with` adds content to an existing powerpoint slide. This function often follows the `add_slide` function. This function is used to add everything from tables, to titles to body paragraphs on your powerpoint slide.

`sprintf` creates a character vector containing a formatted combination of text and variable values. In this notebook it is used for summary notes where it references the paramaters as well as certain variable values.

`filter` is a dplyr function that is used to clean data. Specifically it is used to find rows/cases where a condition is true. If the condition is true then the values are kept, if not they are dropped.

`group_by` takes an existing tbl and converts it into a grouped tbl based on a specific variable.

`rename` does exactly what you think it does. It renames variables based on name.

`replace` replaces a certain value with another. It is used in this notebook to replace NAs with 0.

`pivot_wider` increases the number of columns and decreases the number of rows. It is used in this notebook to widen the number of columns based on month. So the final output table has a column for each month of the year.

`add_row` adds a row to a dataframe. It is used to add rows to tables based on whether or not a specific crime was committed. So, if there were no arsons that month, the `add_row` function is used to add this crime with values of 0.

`arrange` sorts a variable in ascending order

`adorn_totals` adds a "totals" row or column to a data frame.

`colformat_num` formats numeric variables in a flextable. Specifically aimed at controlling the number of digits displayed.

`add_header_lines` adds a header to a flextable.

`autofit` is used to automatically adjust flextable height and width to fit the size of desired content.

`intersect` is used to figure out what columns and rows are shared between dataframes. 

`unlist` 

`cut` divides the unlisted dataframe into intervals and codes their values based on what interval the value falls into. This is how we color the flextables based on their values.

`bg` changes the background color of selected rows/columns in a flextable. We get these values from the `cut` function.

`height_all` sets the height of the flextable. This is used to fit the flextables on the powerpoint slide.

`phl_with_text` adds text to custom layout created via `phl_layout`.

`phl_with_flextable` adds flextable to custom layout created via `phl_layout`.

`is_empty` checks if an object has a value or not. If the value is missing, then we use `add_row` to add the missing crime.

`tm_shape` creates a tmap-element that draws polygons.

`tm_fill` fills map shapes based on what you want. You can either choose a fixed color or map create a color palette mapped to a variable.

`tm_border` adds borders to a map shape

`tm_credits` adds map credits.

`tm_bubbles` creates bubbles. This is how we represent crime points on a map.

`tm_layout` specifies map layout. Used for controlling/creating map legend

`which_min` `which_max` finds the location of the min/max of a vector. This is useful because it gives you the whole row where the min/max is as opposed to just the value of the lowest observation. This is beneficial in the District summaries because it tells us where a min/max value occurs (i.e. what neighborhood)

`ph_add_text` add text to a paragraph.

`ph_add_par` adds an empty paragraph to a powerpoint slide. This is used in the district summaries to create bullet points with only one level per paragraph.

`tmap_save` saves a tmap object.

`ggsave` saves a ggplot object.

`convert_to_pdf` uses libreOffice (another application) to convert the saved powerpoint into a PDF.

`ggplot`initializes a ggplot object. Can be used to specify the data frame and the plot aesthetics.

`geom_bar` creates a bar plot in a ggplot object

`geom_point` creates points in a ggplot object

`geom_line` creates a line plot in a ggplot object.

`scale_colour_manual` used to assign specific color values to ggplot. This references the `cols` vector to make sure that symbology is consistent throughout the report.

`xlab` `ylab` creates axis labels in a ggplot object.

```{r officer layout}
lay <- lay_new(matrix(1:4, nc = 2), widths = c(2,2), heights = c(2,1)) 
title <- lay_new(1, widths = 2, heights = 2)
layout <- lay_bind_row(title, lay, heights = c(1,6))
lay_show(layout)

lay01 <- lay_new(matrix(1:2)) 
title01 <- lay_new(1, widths = 2, heights = 2)
layout01 <- lay_bind_row(title01, lay01, heights = c(1,6))
lay_show(layout01)

## create officer layouts
offlayout <- phl_layout(layout,
    margins = c(0, 1, 1, 0),
    innerMargins = rep(0.15,4))

offlayout01 <- phl_layout(layout01,
    margins = c(0.25, 0.25, 0.25, 0.25),
    innerMargins = rep(0.15,4))
```

```{r Set column name keys for flextable, include = FALSE }
part1crimes <- c("Aggravated Assault", "Arson", "Burgalry", "Homicide", "Larceny", "Motor Vehicle Theft", "Robbery", "Rape")
wkdys <- c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
```

```{r plot and text color palette, inlude = FALSE}
cols <- c("Aggravated Assault" = "#e41a1c", "Arson" = "#A65628", "Burgalry" = "#377eb8", 
          "Homicide" = "#FFFF33", "Larceny" = "#4DAF4A", "Motor Vehicle Theft" = "#984EA3", 
          "Robbery" = "#FF7F00") 

tf_cols <- c("TRUE" = "#DE2D26", "FALSE" = "#FEE0D2")

# summary note colors
reg24 <- fp_text(color = 'black', font.size = 24)
reg20 <- fp_text(color = 'black', font.size = 20)
boldline <- fp_text(color = "black", font.size = 28, bold = TRUE, underlined = TRUE)
bold <- fp_text(color = "black", font.size = 24, bold = TRUE)
```

```{r powerpoint title}
#title slide
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "Forest Park Southeast, Botanical Heights, Central West End, Medical Campus", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with(c(paste("Monthly Crime Report:", params$month, params$year, sep = " "), "Washington University Medical Center"), location = ph_location_type(type = "subTitle")) -> report
```

## Individual Neighborhood Summaries

```{r FPSE Summary Prep, include=FALSE}
#create comments to use to filter and name outputs
comment(fpse_tiles) <- "39"
comment(bot_tiles) <- "28"
comment(cwe_tiles) <- "38"
comment(mc_tiles) <- "100"

for ( i in list(fpse_tiles, bot_tiles, cwe_tiles, mc_tiles) ) { 
num <- as.numeric(comment(i))
  if(num == 100){
    nbhd_pres <- mc_crimes_pres
    nbhd_past <- mc_crimes_past
    ytd_pres <- mc_crimes_ytdpres
    ytd_past <- mc_crimes_ytdpast
    pastyr <- mc_crimes_totpast
    neighborhood <- "Medical Center"
    abbr <- "mc"
  }else{
  nbhd_pres <- filter(monthCrimes_pres, neighborhood == num)
  nbhd_past <- filter(monthCrimes_past, neighborhood == num)
  ytd_pres <- filter(ytdCrimes, neighborhood == num)
  ytd_past <- filter(ytdCrimes_past, neighborhood == num)
  pastyr <- filter(totalCrimes_past, neighborhood == num)
  neighborhood <- unique(nbhd_pres$nbhd_name)
abbr <- unique(nbhd_pres$abbr)
}

tc_past <- nrow(nbhd_past)
tc_pres <- nrow(nbhd_pres)
cap_past <- nrow(nbhd_past[nbhd_past$crimeCatNum == 4 | nbhd_past$crimeCatNum == 3,])
cap_pres <- nrow(nbhd_pres[nbhd_pres$crimeCatNum == 4 | nbhd_pres$crimeCatNum == 3,])
tc_ytd_past <- nrow(ytd_past)
tc_ytdCurrent <- nrow(ytd_pres)
cap_past_ytd <- nrow(ytd_past[ytd_past$crimeCatNum == 4 | ytd_past$crimeCatNum == 3,])
cap_pres_ytd <- nrow(ytd_pres[ytd_pres$crimeCatNum == 4 | ytd_pres$crimeCatNum == 3,])

pct_chg_mth1 <- (tc_pres - tc_past)/tc_past
pct_chg_mth <- percent(pct_chg_mth1)
if(is.nan(pct_chg_mth1)){pct_chg_mth[is.nan(pct_chg_mth1)] <- 0}
if(is.infinite(pct_chg_mth1)){pct_chg_mth[is.infinite(pct_chg_mth1)] <- "Infinite"}

pct_chg_cap1 <- (cap_pres - cap_past)/cap_past
pct_chg_cap <- percent(pct_chg_cap1)
if(is.nan(pct_chg_cap1)){pct_chg_cap[is.nan(pct_chg_cap1)] <- 0}
if(is.infinite(pct_chg_cap1)){pct_chg_cap[is.infinite(pct_chg_cap1)] <- "Infinite"}

pct_chg_ytd1 <- (tc_ytdCurrent - tc_ytd_past)/tc_ytd_past
pct_chg_ytd <- percent(pct_chg_ytd1)
if(is.nan(pct_chg_ytd1)){pct_chg_ytd[is.nan(pct_chg_ytd1)] <- 0}
if(is.infinite(pct_chg_ytd1)){pct_chg_ytd[is.infinite(pct_chg_ytd1)] <- "Infinite"}

pct_chg_ytd_cap1 <- (cap_pres_ytd - cap_past_ytd)/cap_past_ytd
pct_chg_ytd_cap <- percent(pct_chg_ytd_cap1)
if(is.nan(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.nan(pct_chg_ytd_cap1)] <- 0}
if(is.infinite(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.infinite(pct_chg_ytd_cap1)] <- "Infinite"}

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc_pres, params$month, params$year)
sprint_2 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_mth1 == 0, "#00B0F0", ifelse(pct_chg_mth < 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cap1 == 0, "#00B0F0", ifelse(pct_chg_cap < 0, "#00B050", "red")), font.size = 20)
color24b <- fp_text(color = ifelse(pct_chg_ytd1 == 0, '#00B0F0', ifelse(pct_chg_ytd < 0, '#00B050', 'red')), font.size = 24)
color20b <- fp_text(color = ifelse(pct_chg_ytd_cap1 == 0, "#00B0F0", ifelse(pct_chg_ytd_cap < 0, "#00B050", "red")), font.size = 20)

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_mth, "change ", sep = " "), color24a),
       ftext(paste("compared to ", params$month, " ", (params$year - 1), " (", tc_past, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap_pres, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$month, params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_cap, "change", sep = " "), color20a),
       ftext(paste(" compared to ", params$month, " ", (params$year - 1), " (", cap_past, " crimes against persons)", sep = ""), reg20)),
  fpar(ftext(sprint_2, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_ytd, "change ", sep = " "), color24b),
       ftext(paste("compared to this time in ", (params$year - 1), " (", tc_ytd_past, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap_pres_ytd, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_ytd_cap, "change", sep = " "), color20b),
       ftext(paste(" compared to this time in ", (params$year - 1), " (", cap_past_ytd, " crimes against persons)", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = paste(neighborhood, ": Summary Notes"), location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report

#Year to Year Comparison
pastyr %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> yr_past

ytd_pres %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> yr_pres

#create past year flextable, test to determine missing values then add missing values
part1crimes[!(part1crimes %in% yr_past$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(yr_past, crimeCatName = missing_category) -> yr_past
}

yr_past %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> yr_past

flextable(yr_past) %>%
  colformat_num(., digits = 0) %>%
  add_header_lines(values = paste(params$year - 1))%>%
  autofit() -> flex
flex <- height_all(flex, height = .25, part = "all")

#create current year flextable, test to determine missing values then add missing values
part1crimes[!(part1crimes %in% yr_pres$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(yr_pres, crimeCatName = missing_category) -> yr_pres
}

yr_pres %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> yr_pres

#compare dataframes and get common columns
common_cols <- intersect(colnames(yr_pres[, (match(params$month, month.name) + 1)]), colnames(yr_past[, (match(params$month, month.name) + 1)]))

#assign to temporary dataframe
temp_past <- yr_past[,common_cols, drop=FALSE]
temp_pres <- yr_pres[,common_cols, drop=FALSE]

#assign colors, green is a decrease in crime, red is an increase, transparent is no change
colors <- unlist(temp_pres - temp_past)%>%
  cut(breaks = c(-Inf, -.1, 0.1, Inf),
      labels = c("lightgreen", "transparent", "lightcoral")) %>% 
  as.character()
#make flextable, color all columns except the first
flextable(yr_pres) %>% 
  colformat_num(.,  digits = 0) %>%
  bg(j = substr(unique(monthCrimes_pres$monthVar), 1, 3), bg = colors) %>% 
  add_header_lines(values = paste(params$year))%>%
  autofit() -> flex01
flex01 <- height_all(flex01, height = .25, part = "all")

# add powerpoint slide
report%>%
  add_slide()%>%
  phl_with_text(olay = offlayout01, 1, paste(neighborhood, ": Year to Year Comparison"))%>%
  phl_with_flextable(olay = offlayout01, 2, flex)%>%
  phl_with_flextable(olay = offlayout01, 3, flex01) -> report

#Neighborhood Summary Tables
nbhd_pres%>%
  group_by(crimeCatName, .drop = FALSE) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> nbhd_crimeCat

nbhd_pres%>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> nbhd_weekDay

wkdys[!(wkdys %in% nbhd_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(nbhd_weekDay) -> nbhd_weekDay

if(test == FALSE) {
   add_row(nbhd_weekDay, weekday = missing_category_days) -> nbhd_weekDay
}

nbhd_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> nbhd_weekDay

nbhd_pres%>%
  group_by(violent, .drop = FALSE) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> nbhd_violent

nbhd_pres%>%
  group_by(dayNight, .drop = FALSE) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> nbhd_dayNight

#Make flextables from summary data
flextable(nbhd_crimeCat) %>%
  autofit() -> flex01

flextable(nbhd_weekDay) %>%
  colformat_num(., digits = 0) %>%
  autofit() -> flex02

flextable(nbhd_violent) %>%
  autofit() -> flex03

flextable(nbhd_dayNight) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with(paste(neighborhood, ": Summary Tables"), 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 4, flex01)%>%
  phl_with_flextable(olay = offlayout, 2, flex02)%>%
  phl_with_flextable(olay = offlayout, 3, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report

if(num == 100){
  #Total Crimes Map
sub <- mc_crimes_pres_sf
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}

tm_shape(i) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 38) %>%
  tm_shape() +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(med_campus) +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 1,
               lty = "solid") +
  tm_shape(sub) +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> total_tm

tmap_save(total_tm, file = here::here("results", params$year, params$month, abbr, paste(abbr, "_total_tm.jpeg", sep = "")), width = 9, height = 5, units = "in")
}else{
#Total Crimes Map
sub <- filter(monthCrimes_pres_sf, neighborhood == num)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}

tm_shape(i) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == num) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  sub%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> total_tm

tmap_save(total_tm, file = here::here("results", params$year, params$month, abbr, paste(abbr, "_total_tm.jpeg", sep = "")), width = 9, height = 5, units = "in")
}
#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, abbr, paste(abbr, "_total_tm.jpeg", sep = "")), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with(paste(neighborhood, ": Total Crime Map"), 
               location = ph_location_type(
                 type = "title") )-> report

if(num == 38){
  #Total Crimes Map
sub <- ctx_crimes_sf
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burglary" %in% sub$crimeCatName){col <- c(col, "Burglary" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
if("Rape" %in% sub$crimeCatName){col <- c(col, "Rape" = "#F781BF")}

  cwe_ctx_tm <- tm_shape(ctx_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(neighborhood == 38) %>%
  tm_shape() +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(cortex) +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 1,
               lty = "solid") +
  tm_shape(ctx_crimes_sf) +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = cols,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(cwe_ctx_tm, file = here::here("results", params$year, params$month, "cwe", "ctx_total_crimes.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "cwe", "ctx_total_crimes.jpeg"), width = 9, height = 5), location = ph_location_type(type="body"), use_loc_size = FALSE)%>%
  ph_with("Cortex: Total Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
}
  }
```

## District 2: Crime Rates Map

```{r District 2 Density Maps Prep, include = FALSE}
dst2_rateMap <- tm_shape(dst2_tiles) +
  tm_rgb() +
  tm_shape(dst_2_pop_sf) +
  tm_polygons(col = "crimeRate",
              palette = "BuPu",
              style = "jenks",
              title = "Crimes per 1,000 Residents") +
  tm_text("neighborhood", shadow=TRUE) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(dst2_rateMap, file = here("results", params$year, params$month, "district-2", "dst2_rates.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "district-2", "dst2_rates.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("District 2: Crime Rates Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## District 2: Density Map Explanation

```{r District 2 Density Map Explanation Prep, include = FALSE}
options(qwraps2_markup = "markdown")

dst_2_pop_sf <- as.data.frame(dst_2_pop_sf)
summary_statistics <-
  list(
    "Crime Rates" =
      list(
        "mean" = ~mean(crimeRate, na_rm = TRUE),
        "min" = ~min(crimeRate, na.rm = TRUE),
        "max" = ~max(crimeRate, na.rm = TRUE)),
    "Crime Total" =
      list(
        "mean" = ~mean(crimeTotal, na_rm = TRUE),
        "min" = ~min(crimeTotal, na.rm = TRUE),
        "max" = ~max(crimeTotal, na.rm = TRUE)))

dst_2_table <- summary_table(dst_2_pop_sf, summary_statistics)

print(dst_2_table,
      cnames = "Summary Statistics")

dst_2_rate_mean <- mean(dst_2_pop_sf$crimeRate)
dst_2_rate_mean

dst_2_min <- dst_2_pop_sf[which.min(dst_2_pop_sf$crimeRate),]
dst_2_min_rate_nhd <- print(dst_2_min$NHD_NAME, max.levels = 0)
dst_2_min_rate <- print(dst_2_min$crimeRate, max.levels = 0)

dst_2_max <- dst_2_pop_sf[which.max(dst_2_pop_sf$crimeRate),]
dst_2_max_rate_nhd <- print(dst_2_max$NHD_NAME, max.levels = 0)
dst_2_max_rate <- print(dst_2_max$crimeRate, max.levels = 0)

dst_2_total_mean <- mean(dst_2_pop_sf$crimeTotal)
dst_2_total_mean

dst_2_minT <- dst_2_pop_sf[which.min(dst_2_pop_sf$crimeTotal),]
dst_2_min_tot_nhd <- print(dst_2_minT$NHD_NAME, max.levels = 0)
dst_2_min_tot <- print(dst_2_minT$crimeTotal, max.levels = 0)

dst_2_maxT <- dst_2_pop_sf[which.max(dst_2_pop_sf$crimeTotal),]
dst_2_max_tot_nhd <- print(dst_2_maxT$NHD_NAME, max.levels = 0)
dst_2_max_tot <- print(dst_2_maxT$crimeTotal, max.levels = 0)

# add to powerpoint
report%>%
    add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
    ph_with(value = "District 2: Density Map Explanation", location = ph_location_type(type = "title"))%>%
    ph_with(block_list(fpar(ftext("There are 23 neighborhoods in District 2. The South Hampton neighborhood is split between District 2 and District 1.", fp_text(color = "black", font.size = 24)))), location = ph_location_type(type = "body"))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", dst_2_min_tot, " (", dst_2_min_tot_nhd, ")", sep = ""), style = fp_text(color = "black", font.size = 22)) %>%
    ph_add_text(str = "The minimum number of crimes ", 
                style = fp_text(color = "#00B050", font.size = 22))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", dst_2_max_tot, " (", dst_2_max_tot_nhd, ")", sep = ""), style = fp_text(color = "black", font.size = 22))%>%
    ph_add_text(str = "The maximum number of crimes ",
                style = fp_text(color = "red", font.size = 22))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was", round(dst_2_total_mean, digits = 2), 
                            sep = " "), style = fp_text(color = "black", font.size = 22))%>%
    ph_add_text(str = "The mean number of crimes ",
                style = fp_text(color = "#00B0F0", font.size = 22))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", round(dst_2_min_rate, digits = 2), " (", dst_2_min_rate_nhd, ")", sep = ""),
                style = fp_text(color = "black", font.size = 22))%>%
    ph_add_text(str = "The minimum rate of crimes ",
                style = fp_text(color = "#00B050", font.size = 22))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", round(dst_2_max_rate, digits = 2), " (", dst_2_max_rate_nhd, ")", sep = ""),
                style = fp_text(color = "black", font.size = 22))%>%
    ph_add_text(str = "The maximum rate of crimes ",
                style = fp_text(color = "red", font.size = 22))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was", round(dst_2_rate_mean, digits = 2), 
                            sep = " "), style = fp_text(color = "black", font.size = 22))%>%
    ph_add_text(str = "The mean rate of crimes ",
                style = fp_text(color = "#00B0F0", font.size = 22)) -> report
```

## District 5: Crime Rates Map

```{r District 5 Density Map Prep, include = FALSE}
dst5_rateMap <- tm_shape(dst5_tiles) +
  tm_rgb() +
  tm_shape(dst_5_pop_sf) +
  tm_polygons(col = "crimeRate",
              palette = "BuPu",
              style = "jenks",
              title = "Crimes per 1,000 Residents") +
  tm_text("neighborhood", shadow=TRUE) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(dst5_rateMap, file = here("results", params$year, params$month, "district-5", "dst5_rates.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "district-5", "dst5_rates.jpeg"), width = 9, height = 5), location = ph_location_type(type="body"), use_loc_size = FALSE)%>%
  ph_with("District 5: Crime Rates Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## District 5: Density Map Explanation

```{r District 5 Density Map Explanation Prep, include = FALSE}
options(qwraps2_markup = "markdown")

dst_5_pop_sf <- as.data.frame(dst_5_pop_sf)
summary_statistics <-
  list(
    "Crime Rates" =
      list(
        "mean" = ~mean(crimeRate, na_rm = TRUE),
        "min" = ~min(crimeRate, na.rm = TRUE),
        "max" = ~max(crimeRate, na.rm = TRUE)),
    "Crime Total" =
      list(
        "mean" = ~mean(crimeTotal, na_rm = TRUE),
        "min" = ~min(crimeTotal, na.rm = TRUE),
        "max" = ~max(crimeTotal, na.rm = TRUE)))

dst_5_table <- summary_table(dst_5_pop_sf, summary_statistics)

print(dst_5_table,
      cnames = "Summary Statistics")

dst_5_rate_mean <- mean(dst_5_pop_sf$crimeRate)
dst_5_rate_mean

dst_5_min <- dst_5_pop_sf[which.min(dst_5_pop_sf$crimeRate),]
dst_5_min_rate_nhd <- print(dst_5_min$NHD_NAME, max.levels = 0)
dst_5_min_rate <- print(dst_5_min$crimeRate, max.levels = 0)

dst_5_max <- dst_5_pop_sf[which.max(dst_5_pop_sf$crimeRate),]
dst_5_max_rate_nhd <- print(dst_5_max$NHD_NAME, max.levels = 0)
dst_5_max_rate <- print(dst_5_max$crimeRate, max.levels = 0)

dst_5_total_mean <- mean(dst_5_pop_sf$crimeTotal)
dst_5_total_mean

dst_5_minT <- dst_5_pop_sf[which.min(dst_5_pop_sf$crimeTotal),]
dst_5_min_tot_nhd <- print(dst_5_minT$NHD_NAME, max.levels = 0)
dst_5_min_tot <- print(dst_5_minT$crimeTotal, max.levels = 0)

dst_5_maxT <- dst_5_pop_sf[which.max(dst_5_pop_sf$crimeTotal),]
dst_5_max_tot_nhd <- print(dst_5_maxT$NHD_NAME, max.levels = 0)
dst_5_max_tot <- print(dst_5_maxT$crimeTotal, max.levels = 0)

# add to powerpoint
report%>%
    add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "District 5: Density Map Explanation", location = ph_location_type(type = "title"))%>%
    ph_with(block_list(fpar(ftext("There are 15 neighborhoods in District 5", fp_text(color = "black", font.size = 24)))), location = ph_location_type(type = "body"))%>%
    ph_add_par()%>%
    ph_add_text(str = paste(" in one neighborhood was ", dst_5_min_tot, " (", dst_5_min_tot_nhd, ")", sep = ""), style = fp_text(color = "black", font.size = 24)) %>%
    ph_add_text(str = "The minimum number of crimes ", 
                style = fp_text(color = "#00B050", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", dst_5_max_tot, " (", dst_5_max_tot_nhd, ")", sep = ""), style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The maximum number of crimes ",
                style = fp_text(color = "red", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was", round(dst_5_total_mean, digits = 2), 
                            sep = " "), style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The mean number of crimes ",
                style = fp_text(color = "#00B0F0", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", round(dst_5_min_rate, digits = 2), " (", dst_5_min_rate_nhd, ")", sep = ""),
                style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The minimum rate of crimes ",
                style = fp_text(color = "#00B050", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", round(dst_5_max_rate, digits = 2), " (", dst_5_max_rate_nhd, ")", sep = ""),
                style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The maximum rate of crimes ",
                style = fp_text(color = "red", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was", round(dst_5_rate_mean, digits = 2), 
                            sep = " "), style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The mean rate of crimes ",
                style = fp_text(color = "#00B0F0", font.size = 24)) -> report
```

#Appendix
```{r}
#create Appendix number
app = 1
for (i in list(fpse_tiles, cwe_tiles)) {
  num <- as.numeric(comment(i))
  pres_sf <- filter(monthCrimes_pres_sf, neighborhood == num)
  pres_df <- filter(monthCrimes_pres, neighborhood == num)
  neighborhood <- unique(pres_sf$nbhd_name)
abbr <- unique(pres_sf$abbr)

report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = paste(neighborhood, ": Neighborhood Detail"), location = ph_location_type(type = "ctrTitle"))%>%
  ph_with(paste("Appendix", app), location = ph_location_type(type = "subTitle")) -> report
  
  
nbhd_dn_tm <- tm_shape(i) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == num) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  pres_sf%>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(nbhd_dn_tm, file = here("results", params$year, params$month, abbr, paste(abbr, "_day_night.jpeg", sep = "")), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, abbr, paste(abbr, "_day_night.jpeg", sep = "")), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with(paste(neighborhood, ": Time of Crimes Map"), 
               location = ph_location_type(
                 type = "title") )-> report

#Grove community improvement district
if(num == 39){
  grove_crimes <- st_intersection(monthCrimes_pres_sf, grove_cid)
sub <- filter(grove_crimes, neighborhood == 39)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}

fpse_grove_tm <- tm_shape(grv_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 39) %>%
  tm_shape() +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(grove_cid) +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 1,
               lty = "solid") +
  tm_shape(grove_crimes) +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(fpse_grove_tm, file = here("results", params$year, params$month, "fpse", "fpse_grove.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "fpse", "fpse_grove.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Grove Community Improvement District: Total Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
}

#Create Larceny Summary Tables
larceny %>%
  filter(., neighborhood == num) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> larcenies_weekDay

larceny %>%
  filter(., neighborhood == num) %>%
  group_by(dayNight, .drop = FALSE) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> larcenies_dayNight

larceny %>%
  filter(., neighborhood == num) %>%
  group_by(type, .drop = FALSE) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> larcenies_type

larceny %>%
  filter(., neighborhood == num) %>%
  group_by(value, .drop = FALSE) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> larcenies_value

flextable(larcenies_weekDay) %>%
  autofit() -> flex01

flextable(larcenies_dayNight) %>%
  autofit() -> flex02

flextable(larcenies_type) %>%
  autofit() -> flex03

flextable(larcenies_value) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with(paste(neighborhood, ": Larceny Breakdown"), 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 2, flex01)%>%
  phl_with_flextable(olay = offlayout, 3, flex02)%>%
  phl_with_flextable(olay = offlayout, 4, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report

#total crimes by days of the week
pres_df%>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> nbhd_weekDay

wkdys[!(wkdys %in% nbhd_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(nbhd_weekDay) -> nbhd_weekDay

if(test == FALSE) {
   add_row(nbhd_weekDay, weekday = missing_category_days) -> nbhd_weekDay
}

  ggplot(nbhd_weekDay, aes(x=weekday, y=n, group = 1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, abbr, paste(abbr, "_crime_weekday_graph.jpeg", sep = "")), width = 9, height = 5.45, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, abbr, paste(abbr, "_crime_weekday_graph.jpeg", sep = "")), width = 9, height = 5.45),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with(paste(neighborhood, ": Total Crimes by Days of the Week"), 
               location = ph_location_type(
                 type = "title") )-> report

#Crimes by time of day
pres_df%>%
  group_by(dayNight, .drop = FALSE) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, abbr, paste(abbr, "_crime_timeDay_graph.jpeg", sep = "")), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, abbr, paste(abbr, "_crime_timeDay_graph.jpeg", sep = "")), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with(paste(neighborhood, ": Crimes by Time of Day"), 
               location = ph_location_type(
                 type = "title") )-> report

#Crimes by day and Category
pres_df%>%
  group_by(crimeCatName, .drop = FALSE) %>%
  ggplot(., aes(weekday)) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, abbr, paste(abbr, "_crimeCat_weekday_graph.jpeg", sep = "")),
       width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, abbr, paste(abbr, "_crimeCat_weekday_graph.jpeg", sep = "")), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with(paste(neighborhood, ": Crimes by Day & Category"), 
               location = ph_location_type(
                 type = "title") )-> report

app = app + 1
}
```

```{r}
# save powerpoint report
print(report, target = here::here("results", "presentations",  params$year, params$month, paste("fpse-bot-cwe-mc-", params$month, params$year, ".pptx", sep = "")))

#file <- read_pptx(here::here("results", "presentations",  params$year, params$month, paste("fpse-bot-cwe-mc-", params$month, params$year, ".pptx", sep = "")))

#delete any existing fpse-bot-cwe-mc file in the Shiny app
shinydr <- "/Users/loganbogenut/Documents/GitHub/crime_interactive/crime_interactive/www/"
file.remove(file.path(shinydr, dir(path = shinydr, pattern = "Center_crime")))

#convert & save powerpoint as PDF to Shiny app
convert_to_pdf(path = here::here("results", "presentations",  params$year, params$month, paste("fpse-bot-cwe-mc-", params$month, params$year, ".pptx", sep = "")),
               pdf_file = sub("[.]pptx", ".pdf", paste("~/Documents/GitHub/crime_interactive/crime_interactive/www/", "Forest Park Southeast, Botanical Heights, Central West End, Medical Center_crime", ".pptx", sep = "")))

#Create PDF to be stored in current wd
mydir <- paste("/Users/loganbogenut/Documents/GitHub/monthly-crime-reports/results/presentations", "/", params$year, "/", params$month, "/", sep = "")
file.remove(file.path(mydir, dir(path = mydir, pattern = paste("fpse-bot-cwe-mc-", params$month, params$year, ".pdf", sep=""))))

#convert & save powerpoint as PDF to presentations subfolder
convert_to_pdf(path = here::here("results", "presentations",  params$year, params$month, paste("fpse-bot-cwe-mc-", params$month, params$year, ".pptx", sep = "")),
               pdf_file = sub("[.]pptx", ".pdf", paste(mydir, "fpse-bot-cwe-mc-", params$month, params$year, ".pptx", sep = "")))
```

```{r}
# This code cleans our Global Environment.

rm(list = ls())
print("Great job! The code ran all the way through. You did AMAZING!")
```
