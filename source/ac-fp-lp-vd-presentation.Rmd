---
title: "Academy, Fountain Park, Lewis Place Place, Vandeventer"
subtitle: "Monthly Crime report: March 2020" 
author: "Washington University Medical Center"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output:
  powerpoint_presentation
always_allow_html: yes
params:
  month: March
  pastyear: 2019
  year: 2020
  date: "2020-03-01"
  pastdate: "2019-03-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Dependencies and Data, include = FALSE}
# tidyverse packages
library(ggplot2)       # plotting data
library(stringr)       # wrappers for common string operations
library(tidyr)         # tidy data
library(dplyr)         # data manipulation
library(magrittr)      # pipe operator
library(readxl)        # read & write excel files
library(lubridate)     # time data manipulation
library(scales)

# spatial packages
library(tmap)         # map layouts
library(tmaptools)    # tools for handeling spatial
#library(oldtmaptools) # deprecated toolds for spatial analysis
library(sf)           # spatial data tools
library(ceramic)      # download online imagery tiles
#library(compstatr)    # tools for STL crime data
library(raster)       # geograpic data analysis & modeling

# other packages
library(here)         # file path management
library(janitor)      # tools for examining data
library(RColorBrewer) # cynthia brewer color palettes
library(viridis)      # color palettes
library(flextable)   # exporting pretty tables
library(officer)      # powerpoint output
library(htmltools)
library(knitr)
library(tibble)
library(rlang)


# load data
load(file = here("data", "basemap-files", "mapbox-tiles.rda"))
load(file = here("data", "basemap-files", "boundaries.rda"))
load(file = here("data", "crime-data.rda"))
load(file = here("data", "spatial-crime-data.rda"))
load(file = here("data", "nbhd_pop10.rda"))
load(file = here("data", "basemap-files", "nbhd-boundaries.rda"))

# create powerpoint
report <- read_pptx()
```

```{r Set column name keys for flextable, include = FALSE }
colkeys19 <- totalCrimes19$monthVar
colkeys20 <- ytdCrimes20$monthVar
colkeystotal <- c("Total")
part1crimes <- c("Aggravated Assault", "Arson", "Burgalry", "Homicide", "Larceny", "Motor Vehicle Theft", "Robbery")
wkdys <- c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
#tmap_options()
```

```{r plot color palette, inlude = FALSE}
cols <- c("Aggravated Assault" = "#e41a1c", "Arson" = "#A65628", "Burgalry" = "#377eb8", 
          "Homicide" = "#FFFF33", "Larceny" = "#4DAF4A", "Motor Vehicle Theft" = "#984EA3", 
          "Robbery" = "#FF7F00") 
```

```{r powerpoint title}
#title slide
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "Academy, Fountain Park, Lewis Place Place, Vandeventer Monthly Crime Report", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with(c(params$month, params$year), location = ph_location_type(type = "subTitle"))%>%
  ph_with(value = "Washington University Medical Center", 
          location = ph_location_type(type = "dt")) -> report
```


## Academy: Summary Notes

```{r AC Summary Prep, include=FALSE}
tc19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 51,])
tc20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 51,])
cap19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 51 & monthCrimes19$crimeCatNum == 4 | monthCrimes19$neighborhood == 51 & monthCrimes19$crimeCatNum == 3,])
cap20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 51 & monthCrimes20$crimeCatNum == 4 | monthCrimes20$neighborhood == 51 & monthCrimes20$crimeCatNum == 3,])

tc_ytd19 <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 51,])
tc_ytdCurrent <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 51,])
cap19_ytd <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 51 & ytdCrimes19$crimeCatNum == 4 | ytdCrimes19$neighborhood == 51 & ytdCrimes19$crimeCatNum == 3,])
cap20_ytd <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 51 & ytdCrimes20$crimeCatNum == 4 | ytdCrimes20$neighborhood == 51 & ytdCrimes20$crimeCatNum == 3,])

pct_chg_mth <- (tc20 - tc19)/tc19
pct_chg_mth <- percent(pct_chg_mth)

pct_chg_cap <- (cap20 - cap19)/cap19
pct_chg_cap <- percent(pct_chg_cap)

pct_chg_ytd <- (tc_ytdCurrent - tc_ytd19)/tc_ytd19
pct_chg_ytd <- percent(pct_chg_ytd)

pct_chg_ytd_cap <- (cap20_ytd - cap19_ytd)/cap19_ytd
pct_chg_ytd_cap <- percent(pct_chg_ytd_cap)

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total crimes)", 
                    pct_chg_mth, params$month, params$pastyear, tc19)
sprint_3 <- sprintf("%s crime(s) against persons in %s %s", 
                    cap20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s crimes against persons)", 
                    pct_chg_cap, params$month, params$pastyear, cap19)
sprint_5 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total crimes)", 
                    pct_chg_ytd, params$pastyear, tc_ytd19)
sprint_7 <- sprintf("%s crime(s) against persons in %s", 
                    cap20_ytd, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s crimes against persons)", 
                    pct_chg_ytd_cap, params$pastyear, cap19_ytd)

#write sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Academy: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Academy: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```

## Academy: Year to Year Comparison

```{r ac Year Comps Prep, include=FALSE}
totalCrimes19 %>%
  filter(., neighborhood == 51) %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> ac_2019

ytdCrimes20 %>%
  filter(., neighborhood == 51) %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> ac_2020
```

```{r AC Total Crimes Flextable 2019, echo = FALSE}
part1crimes[!(part1crimes %in% ac_2019$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(ac_2019, crimeCatName = missing_category) -> ac_2019
}

ac_2019 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> ac_2019

flextable(ac_2019) %>%
  colformat_num(., digits = 0) %>%
  colformat_num(., digits = 0) %>%
  autofit() -> flex
```

```{r ac Total Crimes Flextable 2020, echo = FALSE}
part1crimes[!(part1crimes %in% ac_2020$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(ac_2020, crimeCatName = missing_category) -> ac_2020
}

ac_2020 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> ac_2020

flextable(ac_2020) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(., digits = 0) %>%
  autofit() -> flex01


#####
####
###
## Fix this powerpoint output
report%>%
    add_slide()%>%
    ph_with(value = "Academy: Year to Year Comparison", location = ph_location_type(type = "title"))%>%
    ph_with(flex, location = ph_location_type("body"))%>%
    ph_with(flex01, location = ph_location_type("body")) -> report
```

## Academy: Summary Tables

```{r AC Tables Prep, include = FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 51) %>%
  group_by(crimeCatName) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> ac_crimeCat

monthCrimes20 %>%
  filter(., neighborhood == 51) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> ac_weekDay

wkdys[!(wkdys %in% ac_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(ac_weekDay) -> ac_weekDay

if(test == FALSE) {
   add_row(ac_weekDay, weekday = missing_category_days) -> ac_weekDay
}

ac_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> ac_weekDay

monthCrimes20 %>%
  filter(., neighborhood == 51) %>%
  group_by(violent) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> ac_violent

monthCrimes20 %>%
  filter(., neighborhood == 51) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> ac_dayNight

```

```{r AC Flextables Knit, echo = FALSE}
flextable(ac_crimeCat) %>%
  autofit()

flextable(ac_weekDay) %>%
  autofit()

flextable(ac_violent) %>%
  autofit()

flextable(ac_dayNight) %>%
  autofit()
```

## Academy: Total Crime Map

```{r Academy color palette, include = FALSE}
sub <- filter(monthCrimes20_sf, neighborhood == 51)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
```

```{r AC Total Crime Prep, include = FALSE}
tm_shape(ac_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 51) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 51) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> ac_total_tm

tmap_save(ac_total_tm, file = here("results", params$year, params$month, "ac", "ac_total_tm.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "ac", "ac_total_tm.jpeg"), width = 5.21, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Academy: Total Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```


## Fountain Park: Summary Notes

```{r FP Summary Prep, include=FALSE}
tc19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 53,])
tc20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 53,])
cap19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 53 & monthCrimes19$crimeCatNum == 4 | monthCrimes19$neighborhood == 53 & monthCrimes19$crimeCatNum == 3,])
cap20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 53 & monthCrimes20$crimeCatNum == 4 | monthCrimes20$neighborhood == 53 & monthCrimes20$crimeCatNum == 3,])

tc_ytd19 <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 53,])
tc_ytdCurrent <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 53,])
cap19_ytd <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 53 & ytdCrimes19$crimeCatNum == 4 | ytdCrimes19$neighborhood == 53 & ytdCrimes19$crimeCatNum == 3,])
cap20_ytd <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 53 & ytdCrimes20$crimeCatNum == 4 | ytdCrimes20$neighborhood == 53 & ytdCrimes20$crimeCatNum == 3,])

pct_chg_mth <- (tc20 - tc19)/tc19
pct_chg_mth <- percent(pct_chg_mth)
pct_chg_cap <- (cap20 - cap19)/cap19
pct_chg_cap <- percent(pct_chg_cap)
pct_chg_ytd <- (tc_ytdCurrent - tc_ytd19)/tc_ytd19
pct_chg_ytd <- percent(pct_chg_ytd)
pct_chg_ytd_cap <- (cap20_ytd - cap19_ytd)/cap19_ytd
pct_chg_ytd_cap <- percent(pct_chg_ytd_cap)

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total crimes)", 
                    pct_chg_mth, params$month, params$pastyear, tc19)
sprint_3 <- sprintf("%s crime(s) against persons in %s %s", 
                    cap20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s crimes against persons)", 
                    pct_chg_cap, params$month, params$pastyear, cap19)
sprint_5 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total crimes)", 
                    pct_chg_ytd, params$pastyear, tc_ytd19)
sprint_7 <- sprintf("%s crime(s) against persons in %s", 
                    cap20_ytd, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s crimes against persons)", 
                    pct_chg_ytd_cap, params$pastyear, cap19_ytd)

#write sprints to powerpoint
report%>%
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Fountain Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_1, sprint_2, sprint_3, sprint_4), 
          location = ph_location_type(type = "body"))%>%

  #add extra slide for summary notes
  add_slide(layout = "Title and Content", master = "Office Theme")%>%
  ph_with(value = "Fountain Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(c(sprint_5, sprint_6, sprint_7, sprint_8), 
          location = ph_location_type(type = "body")) -> report
```

- **`r sprint_1`**
- **`r sprint_2`**
- **`r sprint_3`**
- **`r sprint_4`**
- **`r sprint_5`**
- **`r sprint_6`**
- **`r sprint_7`**
- **`r sprint_8`**

## Fountain Park: Year to Year Comparison

```{r fp Year Comps Prep, include=FALSE}
totalCrimes19 %>%
  filter(., neighborhood == 53) %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> fp_2019

ytdCrimes20 %>%
  filter(., neighborhood == 53) %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> fp_2020
```

```{r FP Total Crimes Flextable 2019, echo = FALSE}
part1crimes[!(part1crimes %in% fp_2019$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(fp_2019, crimeCatName = missing_category) -> fp_2019
}

fp_2019 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> fp_2019

flextable(fp_2019) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  autofit()
```

```{r fp Total Crimes Flextable 2020, echo = FALSE}
part1crimes[!(part1crimes %in% fp_2020$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(fp_2020, crimeCatName = missing_category) -> fp_2020
}

fp_2020 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> fp_2020

flextable(fp_2020) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  autofit()
```

## Fountain Park: Summary Tables

```{r FP Tables Prep, include = FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 53) %>%
  group_by(crimeCatName) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> fp_crimeCat

monthCrimes20 %>%
  filter(., neighborhood == 53) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> fp_weekDay

wkdys[!(wkdys %in% fp_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(fp_weekDay) -> fp_weekDay

if(test == FALSE) {
   add_row(fp_weekDay, weekday = missing_category_days) -> fp_weekDay
}

fp_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> fp_weekDay

monthCrimes20 %>%
  filter(., neighborhood == 53) %>%
  group_by(violent) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> fp_violent


monthCrimes20 %>%
  filter(., neighborhood == 53) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> fp_dayNight
```

```{r FP Flextables Knit, echo = FALSE}
flextable(fp_crimeCat) %>%
  autofit()

flextable(fp_weekDay) %>%
  autofit()

flextable(fp_violent) %>%
  autofit()

flextable(fp_dayNight) %>%
  autofit()
```

## Fountain Park: Total Crime Map

```{r FP color palette, include = FALSE}
sub <- filter(monthCrimes20_sf, neighborhood == 53)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
```

```{r FP Total Crime Prep, include = FALSE}
tm_shape(fp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 53) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 53) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> fp_total_tm

tmap_save(fp_total_tm, file = here("results", params$year, params$month, "fp", "fp_total_crimes.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "fp", "fp_total_crimes.jpeg"), width = 4.06, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Fountain Park", 
               location = ph_location_type(
                 type = "title") )-> report
```



## Summary Notes: Lewis Place

```{r LP Summary Notes Prep, include=FALSE}
tc19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 54,])
tc20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 54,])
cap19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 54 & monthCrimes19$crimeCatNum == 4 | monthCrimes19$neighborhood == 54 & monthCrimes19$crimeCatNum == 3,])
cap20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 54 & monthCrimes20$crimeCatNum == 4 | monthCrimes20$neighborhood == 54 & monthCrimes20$crimeCatNum == 3,])

tc_ytd19 <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 54,])
tc_ytdCurrent <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 54,])
cap19_ytd <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 54 & ytdCrimes19$crimeCatNum == 4 | ytdCrimes19$neighborhood == 54 & ytdCrimes19$crimeCatNum == 3,])
cap20_ytd <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 54 & ytdCrimes20$crimeCatNum == 4 | ytdCrimes20$neighborhood == 54 & ytdCrimes20$crimeCatNum == 3,])

pct_chg_mth <- (tc20 - tc19)/tc19
pct_chg_mth <- percent(pct_chg_mth)
#pct_chg_cap <- (cap20 - cap19)/cap19
#pct_chg_cap <- percent(pct_chg_cap)
pct_chg_ytd <- (tc_ytdCurrent - tc_ytd19)/tc_ytd19
pct_chg_ytd <- percent(pct_chg_ytd)
#pct_chg_ytd_cap <- (cap20_ytd - cap19_ytd)/cap19_ytd
#pct_chg_ytd_cap <- percent(pct_chg_ytd_cap)

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total crimes)", 
                    pct_chg_mth, params$month, params$pastyear, tc19)
#sprint_3 <- sprintf("%s crime(s) against persons in %s %s", 
                    #cap20, params$month, params$year)
#sprint_4 <- sprintf("%s change compared to %s %s (%s crimes against persons)", 
                   # pct_chg_cap, params$month, params$pastyear, cap19)
sprint_5 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total crimes)", 
                    pct_chg_ytd, params$pastyear, tc_ytd19)
#sprint_7 <- sprintf("%s crime(s) against persons in %s", 
                   # cap20_ytd, params$year)
#sprint_8 <- sprintf("%s change compared to this time in %s (%s crimes against persons)", 
                    #pct_chg_ytd_cap, params$pastyear, cap19_ytd)
```

- **`r sprint_1`**
- **`r sprint_2`**
- **`r sprint_3`**
- **`r sprint_4`**
- **`r sprint_5`**
- **`r sprint_6`**
- **`r sprint_7`**
- **`r sprint_8`**

## Lewis Place: Year to Year Comparison

```{r lp Year Comps Prep, include=FALSE}
totalCrimes19 %>%
  filter(., neighborhood == 54) %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> lp_2019

ytdCrimes20 %>%
  filter(., neighborhood == 54) %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> lp_2020
```

```{r lp Total Crimes Flextable 2019, echo = FALSE}
part1crimes[!(part1crimes %in% lp_2019$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(lp_2019, crimeCatName = missing_category) -> lp_2019
}

lp_2019 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> lp_2019

flextable(lp_2019) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  autofit()
```

```{r lp Total Crimes Flextable 2020, echo = FALSE}
part1crimes[!(part1crimes %in% lp_2020$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(lp_2020, crimeCatName = missing_category) -> lp_2020
}

lp_2020 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> lp_2020

flextable(lp_2020) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(., digits = 0) %>%
  autofit()
```

## Lewis Place: Summary Tables

```{r LP Tables Prep, include = FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 54) %>%
  group_by(crimeCatName) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> lp_crimeCat

monthCrimes20 %>%
  filter(., neighborhood == 54) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> lp_weekDay

wkdys[!(wkdys %in% lp_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(lp_weekDay) -> lp_weekDay

if(test == FALSE) {
   add_row(lp_weekDay, weekday = missing_category_days) -> lp_weekDay
}

lp_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> lp_weekDay

monthCrimes20 %>%
  filter(., neighborhood == 54) %>%
  group_by(violent) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> lp_violent

monthCrimes20 %>%
  filter(., neighborhood == 54) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> lp_dayNight

```

```{r LP Flextables Knit, echo = FALSE}
flextable(lp_crimeCat) %>%
  autofit()

flextable(lp_weekDay) %>%
  autofit()

flextable(lp_violent) %>%
  autofit()

flextable(lp_dayNight) %>%
  autofit()
```

## Lewis Place: Total Crime Map

```{r LP color palette, include = FALSE}
sub <- filter(monthCrimes20_sf, neighborhood == 54)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
```

```{r LP Total Crime Prep, include = FALSE}
tm_shape(lp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 54) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 54) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> lp_total_tm

tmap_save(lp_total_tm, file = here("results", params$year, params$month, "lp", "lp_total_crimes.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "lp", "lp_total_crimes.jpeg"), width = 6.18, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Lewis Place", 
               location = ph_location_type(
                 type = "title") )-> report
```


## Vandeventer: Summary Notes

```{r VD Summary Prep, include=FALSE}
tc19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 58,])
tc20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 58,])
cap19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 58 & monthCrimes19$crimeCatNum == 4 | monthCrimes19$neighborhood == 58 & monthCrimes19$crimeCatNum == 3,])
cap20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 58 & monthCrimes20$crimeCatNum == 4 | monthCrimes20$neighborhood == 58 & monthCrimes20$crimeCatNum == 3,])

tc_ytd19 <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 58,])
tc_ytdCurrent <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 58,])
cap19_ytd <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 58 & ytdCrimes19$crimeCatNum == 4 | ytdCrimes19$neighborhood == 58 & ytdCrimes19$crimeCatNum == 3,])
cap20_ytd <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 58 & ytdCrimes20$crimeCatNum == 4 | ytdCrimes20$neighborhood == 58 & ytdCrimes20$crimeCatNum == 3,])

pct_chg_mth <- (tc20 - tc19)/tc19
pct_chg_mth <- percent(pct_chg_mth)
pct_chg_cap <- (cap20 - cap19)/cap19
pct_chg_cap <- percent(pct_chg_cap)
pct_chg_ytd <- (tc_ytdCurrent - tc_ytd19)/tc_ytd19
pct_chg_ytd <- percent(pct_chg_ytd)
pct_chg_ytd_cap <- (cap20_ytd - cap19_ytd)/cap19_ytd
pct_chg_ytd_cap <- percent(pct_chg_ytd_cap)

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc20, params$month, params$year)
sprint_2 <- sprintf("%s change compared to %s %s (%s total crimes)", 
                    pct_chg_mth, params$month, params$pastyear, tc19)
sprint_3 <- sprintf("%s crime(s) against persons in %s %s", 
                    cap20, params$month, params$year)
sprint_4 <- sprintf("%s change compared to %s %s (%s crimes against persons)", 
                    pct_chg_cap, params$month, params$pastyear, cap19)
sprint_5 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)
sprint_6 <- sprintf("%s change compared to this time in %s (%s total crimes)", 
                    pct_chg_ytd, params$pastyear, tc_ytd19)
sprint_7 <- sprintf("%s crime(s) against persons in %s", 
                    cap20_ytd, params$year)
sprint_8 <- sprintf("%s change compared to this time in %s (%s crimes against persons)", 
                    pct_chg_ytd_cap, params$pastyear, cap19_ytd)
```

- **`r sprint_1`**
- **`r sprint_2`**
- **`r sprint_3`**
- **`r sprint_4`**
- **`r sprint_5`**
- **`r sprint_6`**
- **`r sprint_7`**
- **`r sprint_8`**

## Vandeventer: Year to Year Comparison

```{r vd Year Comps Prep, include=FALSE}
totalCrimes19 %>%
  filter(., neighborhood == 58) %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> vd_2019

ytdCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> vd_2020
```

```{r vd Total Crimes Flextable 2019, echo = FALSE}
part1crimes[!(part1crimes %in% vd_2019$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(vd_2019, crimeCatName = missing_category) -> vd_2019
}

vd_2019 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> vd_2019

flextable(vd_2019) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  autofit()
```

```{r vd Total Crimes Flextable 2020, echo = FALSE}
part1crimes[!(part1crimes %in% vd_2020$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(vd_2020, crimeCatName = missing_category) -> vd_2020
}

vd_2020 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> vd_2020

flextable(vd_2020) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  autofit()
```

## Vandeventer: Summary Tables

```{r VD Tables Prep, include = FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(crimeCatName) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> vd_crimeCat

monthCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> vd_weekDay

wkdys[!(wkdys %in% vd_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(vd_weekDay) -> vd_weekDay

if(test == FALSE) {
   add_row(vd_weekDay, weekday = missing_category_days) -> vd_weekDay
}

vd_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> vd_weekDay

monthCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(violent) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> vd_violent

monthCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> vd_dayNight

```

```{r VD Flextables Knit, echo = FALSE}
flextable(vd_crimeCat) %>%
  autofit()

flextable(vd_weekDay) %>%
  autofit()

flextable(vd_violent) %>%
  autofit()

flextable(vd_dayNight) %>%
  autofit()
```

## Vandeventer: Total Crime Map

```{r VD color palette, include = FALSE}
sub <- filter(monthCrimes20_sf, neighborhood == 58)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
```

```{r VD Total Crime Prep, include = FALSE}
tm_shape(vd_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 58) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 58) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vd_total_tm

tmap_save(vd_total_tm, file = here("results", params$year, params$month, "vd", "vd_total_tm.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vd", "vd_total_tm.jpeg"), width = 8.27, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Vandeventer", 
               location = ph_location_type(
                 type = "title") )-> report
```

## District 5: Crime Rates Map

```{r District 5 Density Map Knit, echo = FALSE}
#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "district-5", "dst5_rates.jpeg"), width = 7.88, height = 7.32), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("District 5: Crime Rates Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r District 5 Density Map Explanation Prep, include = FALSE}
library(qwraps2)
options(qwraps2_markup = "markdown")

dst_5_pop_sf <- as.data.frame(dst_5_pop_sf)
summary_statistics <-
  list(
    "Crime Rates" =
      list(
        "mean" = ~mean(crimeRate, na_rm = TRUE),
        "min" = ~min(crimeRate, na.rm = TRUE),
        "max" = ~max(crimeRate, na.rm = TRUE)),
    "Crime Total" =
      list(
        "mean" = ~mean(crimeTotal, na_rm = TRUE),
        "min" = ~min(crimeTotal, na.rm = TRUE),
        "max" = ~max(crimeTotal, na.rm = TRUE)))

dst_5_table <- summary_table(dst_5_pop_sf, summary_statistics)

print(dst_5_table,
      cnames = "Summary Statistics")

dst_5_rate_mean <- mean(dst_5_pop_sf$crimeRate)
dst_5_rate_mean

dst_5_min <- dst_5_pop_sf[which.min(dst_5_pop_sf$crimeRate),]
dst_5_min_rate_nhd <- print(dst_5_min$NHD_NAME, max.levels = 0)
dst_5_min_rate <- print(dst_5_min$crimeRate, max.levels = 0)

dst_5_max <- dst_5_pop_sf[which.max(dst_5_pop_sf$crimeRate),]
dst_5_max_rate_nhd <- print(dst_5_max$NHD_NAME, max.levels = 0)
dst_5_max_rate <- print(dst_5_max$crimeRate, max.levels = 0)

dst_5_total_mean <- mean(dst_5_pop_sf$crimeTotal)
dst_5_total_mean

dst_5_minT <- dst_5_pop_sf[which.min(dst_5_pop_sf$crimeTotal),]
dst_5_min_tot_nhd <- print(dst_5_minT$NHD_NAME, max.levels = 0)
dst_5_min_tot <- print(dst_5_minT$crimeTotal, max.levels = 0)

dst_5_maxT <- dst_5_pop_sf[which.max(dst_5_pop_sf$crimeTotal),]
dst_5_max_tot_nhd <- print(dst_5_maxT$NHD_NAME, max.levels = 0)
dst_5_max_tot <- print(dst_5_maxT$crimeTotal, max.levels = 0)

sprint_1 <- sprintf("The minimum number of crimes in one neighborhood was %s (%s)", dst_5_min_tot, dst_5_min_tot_nhd)
sprint_2 <- sprintf("The maximum number of crimes in one neighborhood was %s (%s)", dst_5_max_tot, dst_5_max_tot_nhd)
sprint_3 <- sprintf("The mean number of crimes in one neighborhood was %s", round(dst_5_total_mean, digits = 2))
sprint_4 <- sprintf("The minimum rate of crimes in one neighborhood was %s (%s)", round(dst_5_min_rate, digits = 2), dst_5_min_rate_nhd)
sprint_5 <- sprintf("The maximum rate of crimes in one neighborhood was %s (%s)", round(dst_5_max_rate, digits = 2), dst_5_max_rate_nhd)
sprint_6 <- sprintf("The mean rate of crimes in one neighborhood was %s", round(dst_5_rate_mean, digits = 2))
```

## District 5: Density Map Explanation

There are 15 neighborhoods in District 5.

- **`r sprint_1`**
- **`r sprint_2`**
- **`r sprint_3`**
- **`r sprint_4`**
- **`r sprint_5`**
- **`r sprint_6`**

## Academy: Neighborhood Detail
### Appendix 1

## Academy: Time of Crimes Map

```{r AC Day & Night Prep, include = FALSE}
ac_dn_tm <- tm_shape(ac_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 51) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 51) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(ac_dn_tm, file = here("results", params$year, params$month, "ac", "ac_day_night.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "ac", "ac_day_night.jpeg"), width = 5.21, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Academy: Time of Crimes Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Academy: Violent Crime Map

```{r AC Violent Crime Map Prep, include = FALSE}
ac_vlnt_tm <- tm_shape(ac_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 51) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 51) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "violent",
               palette = "Reds",
               title.col = "Violent") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(ac_vlnt_tm, file = here("results", params$year, params$month, "ac", "ac_vlnt.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "ac", "ac_vlnt.jpeg"), width = 5.21, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Academy: Violent Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Academy: Crime Density Map

```{r AC Density Map Prep, include = FALSE}
monthCrimes20_sf %>%
  filter(neighborhood == 51) %>%
  smooth_map(., bandwidth = 0.5, style = "pretty",
  cover = ac) -> ac_densities

ac_den_tm <- tm_shape(ac_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 51) %>%
  tm_shape() +
    tm_fill(col = NA,
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(ac_densities$polygons) +
  tm_fill(col = "level", palette = "BuPu", alpha = .60,
    title = expression("Crimes per " * km^2)) +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(ac_den_tm, file = here("results", params$year, params$month, "ac", "ac_density.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "ac", "ac_density.jpeg"), width = 5.21, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Academy: Crime Density Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Academy: Larceny Breakdown

```{r AC Larceny Breakdown Prep, include = FALSE}
larceny %>%
  filter(., neighborhood == 51) %>%
  group_by(weekday) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> ac_larcenies_weekDay

larceny %>%
  filter(., neighborhood == 51) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> ac_larcenies_dayNight

larceny %>%
  filter(., neighborhood == 51) %>%
  group_by(type) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> ac_larcenies_type

larceny %>%
  filter(., neighborhood == 51) %>%
  group_by(value) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> ac_larcenies_value
```

```{r AC Larceny Tables Knit, echo = FALSE}
flextable(ac_larcenies_weekDay) %>%
  autofit()

flextable(ac_larcenies_dayNight) %>%
  autofit()

flextable(ac_larcenies_type) %>%
  autofit()

flextable(ac_larcenies_value) %>%
  autofit()
```

## Academy: Total Crimes by Days of the Week

```{r AC Crime by Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 51) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> ac_weekDay

wkdys[!(wkdys %in% ac_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(ac_weekDay) -> ac_weekDay

if(test == FALSE) {
   add_row(ac_weekDay, weekday = missing_category_days) -> ac_weekDay
}

  ggplot(ac_weekDay, aes(x=weekday, y=n, group = 1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, "ac", "ac_crime_weekday_graph.jpeg"), dpi = 500)
```

```{r AC Crime by Weekday Graph Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "ac", "ac_crime_weekday_graph.jpeg"), dpi = 500)
```

## Academy: Crimes by Time of Day

```{r AC Crime by Time of Day Graph Prep, include = FALSE }
monthCrimes20 %>%
  filter(., neighborhood == 51) %>%
  group_by(dayNight) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, "ac", "ac_crime_timeDay_graph.jpeg"), dpi = 500)
```

```{r AC Crime by Time of Day Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "ac", "ac_crime_timeDay_graph.jpeg"), dpi = 500)
```

## Academy: Crimes by Day & Category

```{r AC Crime by Category Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 51) %>%
  group_by(crimeCatName) %>%
  ggplot(., aes(weekday)) +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, "ac", "ac_crimeCat_weekday_graph.jpeg"), dpi = 500)
```

```{r AC Crime by Category Weekday Graph Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "ac", "ac_crimeCat_weekday_graph.jpeg"), dpi = 500)
```

## Fountain Park: Neighborhood Detail
### Appendix 2

## Fountain Park: Time of Crimes Map

```{r FP Day & Night Prep, include = FALSE}
fp_dn_tm <- tm_shape(fp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 53) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 53) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(fp_dn_tm, file = here("results", params$year, params$month, "fp", "fp_day_night.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "fp", "fp_day_night.jpeg"), width = 4.06, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Fountain Park: Time of Crimes Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Fountain Park: Violent Crime Map

```{r FP Violent Crime Map Prep, include = FALSE}
fp_vlnt_tm <- tm_shape(fp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 53) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 53) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "violent",
               palette = "Reds",
               title.col = "Violent") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(fp_vlnt_tm, file = here("results", params$year, params$month, "fp", "fp_vlnt.jpeg"), dpi = 500)

report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "fp", "fp_vlnt.jpeg"), width = 4.06, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Fountain Park: Violent Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Fountain Park: Crime Density Map

```{r FP Density Map Prep, include = FALSE}
monthCrimes20_sf %>%
  filter(neighborhood == 53) %>%
  smooth_map(., bandwidth = 0.5, style = "pretty",
  cover = fp) -> fp_densities

fp_den_tm <- tm_shape(fp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 53) %>%
  tm_shape() +
    tm_fill(col = NA,
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(fp_densities$polygons) +
  tm_fill(col = "level", palette = "BuPu", alpha = .60,
    title = expression("Crimes per " * km^2)) +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(fp_den_tm, file = here("results", params$year, params$month, "fp", "fp_density.jpeg"), dpi = 500)

report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "fp", "fp_density.jpeg"), width = 4.06, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Fountain Park: Crime Density Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Fountain Park: Larceny Breakdown

```{r FP Larceny Breakdown Prep, include = FALSE}
larceny %>%
  filter(., neighborhood == 53) %>%
  group_by(weekday) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> fp_larcenies_weekDay

larceny %>%
  filter(., neighborhood == 53) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> fp_larcenies_dayNight

larceny %>%
  filter(., neighborhood == 53) %>%
  group_by(type) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> fp_larcenies_type

larceny %>%
  filter(., neighborhood == 53) %>%
  group_by(value) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> fp_larcenies_value
```

```{r FP Larceny Tables Knit, echo = FALSE}
flextable(fp_larcenies_weekDay) %>%
  autofit()

flextable(fp_larcenies_dayNight) %>%
  autofit()

flextable(fp_larcenies_type) %>%
  autofit()

flextable(fp_larcenies_value) %>%
  autofit()
```

## Fountain Park: Total Crimes by Days of the Week

```{r FP Crime by Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 53) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> fp_weekDay

wkdys[!(wkdys %in% fp_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(fp_weekDay) -> fp_weekDay

if(test == FALSE) {
   add_row(fp_weekDay, weekday = missing_category_days) -> fp_weekDay
}

  ggplot(fp_weekDay, aes(x=weekday, y=n, group = 1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, "fp", "fp_crime_weekday_graph.jpeg"), dpi = 500)
```

```{r FP Crime by Weekday Graph Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "fp", "fp_crime_weekday_graph.jpeg"), dpi = 500)
```

## Fountain Park: Crimes by Time of Day

```{r FP Crime by Time of Day Graph Prep, include = FALSE }
monthCrimes20 %>%
  filter(., neighborhood == 53) %>%
  group_by(dayNight) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, "fp", "fp_crime_timeDay_graph.jpeg"), dpi = 500)
```

```{r FP Crime by Time of Day Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "fp", "fp_crime_timeDay_graph.jpeg"), dpi = 500)
```

## Fountain Park: Crimes by Day & Category

```{r FP Crime by Category Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 53) %>%
  group_by(crimeCatName) %>%
  ggplot(., aes(weekday)) +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, "fp", "fp_crimeCat_weekday_graph.jpeg"), dpi = 500)
```

```{r FP Crime by Category Weekday Graph Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "fp", "fp_crimeCat_weekday_graph.jpeg"), dpi = 500)
```

## Lewis Place: Neighborhood Detail
### Appendix 3

## Lewis Place: Time of Crimes Map

```{r LP Day & Night Prep, include = FALSE}
lp_dn_tm <- tm_shape(lp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 54) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 54) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(lp_dn_tm, file = here("results", params$year, params$month, "lp", "lp_day_night.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "lp", "lp_day_night.jpeg"), width = 6.18, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Lewis Place: Time of Crimes Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Lewis Place: Violent Crime Map

```{r LP Violent Crime Map Prep, include = FALSE}
lp_vlnt_tm <- tm_shape(lp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 54) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 54) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "violent",
               palette = "Reds",
               title.col = "Violent") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(lp_vlnt_tm, file = here("results", params$year, params$month, "lp", "lp_vlnt.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "lp", "lp_vlnt.jpeg"), width = 6.18, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Lewis Place: Violent Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Lewis Place: Crime Density Map

```{r LP Density Map Prep, include = FALSE}
monthCrimes20_sf %>%
  filter(neighborhood == 54) %>%
  smooth_map(., bandwidth = 0.5, style = "pretty",
  cover = lp) -> lp_densities

lp_den_tm <- tm_shape(lp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 54) %>%
  tm_shape() +
    tm_fill(col = NA,
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(lp_densities$polygons) +
  tm_fill(col = "level", palette = "BuPu", alpha = .60,
    title = expression("Crimes per " * km^2)) +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(lp_den_tm, file = here("results", params$year, params$month, "lp", "lp_density.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "lp", "lp_density.jpeg"), width = 6.18, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Lewis Place: Crime Density Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r LP Density Map Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "lp", "lp_density.jpeg"))
```

## Lewis Place: Larceny Breakdown

```{r LP Larceny Breakdown Prep, include = FALSE}
larceny %>%
  filter(., neighborhood == 54) %>%
  group_by(weekday) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> lp_larcenies_weekDay

larceny %>%
  filter(., neighborhood == 54) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> lp_larcenies_dayNight

larceny %>%
  filter(., neighborhood == 54) %>%
  group_by(type) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> lp_larcenies_type

larceny %>%
  filter(., neighborhood == 54) %>%
  group_by(value) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> lp_larcenies_value
```

```{r LP Larceny Tables Knit, echo = FALSE}
flextable(lp_larcenies_weekDay) %>%
  autofit()

flextable(lp_larcenies_dayNight) %>%
  autofit()

flextable(lp_larcenies_type) %>%
  autofit()

flextable(lp_larcenies_value) %>%
  autofit()
```

## Lewis Place: Total Crimes by Days of the Week

```{r LP Crime by Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 54) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> lp_weekDay

wkdys[!(wkdys %in% lp_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(lp_weekDay) -> lp_weekDay

if(test == FALSE) {
   add_row(lp_weekDay, weekday = missing_category_days) -> lp_weekDay
}

  ggplot(lp_weekDay, aes(x=weekday, y=n, group = 1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, "lp", "lp_crime_weekday_graph.jpeg"), dpi = 500)
```

```{r LP Crime by Weekday Graph Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "lp", "lp_crime_weekday_graph.jpeg"), dpi = 500)
```

## Lewis Place: Crimes by Time of Day

```{r LP Crime by Time of Day Graph Prep, include = FALSE }
monthCrimes20 %>%
  filter(., neighborhood == 54) %>%
  group_by(dayNight) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, "lp", "lp_crime_timeDay_graph.jpeg"), dpi = 500)
```

```{r LP Crime by Time of Day Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "lp", "lp_crime_timeDay_graph.jpeg"), dpi = 500)
```

## Lewis Place: Crimes by Day & Category

```{r LP Crime by Category Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 54) %>%
  group_by(crimeCatName) %>%
  ggplot(., aes(weekday)) +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, "lp", "lp_crimeCat_weekday_graph.jpeg"), dpi = 500)
```

```{r LP Crime by Category Weekday Graph Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "lp", "lp_crimeCat_weekday_graph.jpeg"), dpi = 500)
```

## Vandeventer: Neighborhood Detail
### Appendix 4

## Vandeventer: Time of Crimes Map

```{r VD Day & Night Prep, include = FALSE}
vd_dn_tm <- tm_shape(vd_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 58) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 58) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(vd_dn_tm, file = here("results", params$year, params$month, "vd", "vd_day_night.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vd", "vd_day_night.jpeg"), width = 8.27, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Vandeventer: Time of Crimes Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Vandeventer: Violent Crime Map

```{r VD Violent Crime Map Prep, include = FALSE}
vd_vlnt_tm <- tm_shape(vd_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 58) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 58) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "violent",
               palette = "Reds",
               title.col = "Violent") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(vd_vlnt_tm, file = here("results", params$year, params$month, "vd", "vd_vlnt.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vd", "vd_vlnt.jpeg"), width = 8.27, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Vandeventer: Violent Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Vandeventer: Crime Density Map

```{r VD Density Map Prep, include = FALSE}
monthCrimes20_sf %>%
  filter(neighborhood == 58) %>%
  smooth_map(., bandwidth = 0.5, style = "pretty",
  cover = vd) -> vd_densities

vd_den_tm <- tm_shape(vd_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 58) %>%
  tm_shape() +
    tm_fill(col = NA,
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(vd_densities$polygons) +
  tm_fill(col = "level", palette = "BuPu", alpha = .60,
    title = expression("Crimes per " * km^2)) +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(vd_den_tm, file = here("results", params$year, params$month, "vd", "vd_density.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vd", "vd_day_night.jpeg"), width = 8.27, height = 7.5), location = ph_location_type(type = "title"), use_loc_size = FALSE)%>%
  ph_with("Vandeventer: Crime Density Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r VD Density Map Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "vd", "vd_density.jpeg"))
```

## Vandeventer: Larceny Breakdown

```{r VD Larceny Breakdown Prep, include = FALSE}
larceny %>%
  filter(., neighborhood == 58) %>%
  group_by(weekday) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> vd_larcenies_weekDay

larceny %>%
  filter(., neighborhood == 58) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> vd_larcenies_dayNight

larceny %>%
  filter(., neighborhood == 58) %>%
  group_by(type) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> vd_larcenies_type

larceny %>%
  filter(., neighborhood == 58) %>%
  group_by(value) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> vd_larcenies_value
```

```{r VD Larceny Tables Knit, echo = FALSE}
flextable(vd_larcenies_weekDay) %>%
  autofit()

flextable(vd_larcenies_dayNight) %>%
  autofit()

flextable(vd_larcenies_type) %>%
  autofit()

flextable(vd_larcenies_value) %>%
  autofit()
```

## Vandeventer: Total Crimes by Days of the Week

```{r VD Crime by Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> vd_weekDay

wkdys[!(wkdys %in% vd_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(vd_weekDay) -> vd_weekDay

if(test == FALSE) {
   add_row(vd_weekDay, weekday = missing_category_days) -> vd_weekDay
}

  ggplot(vd_weekDay, aes(x=weekday, y=n, group = 1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

monthCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(weekday) %>%
  count() %>%
  ggplot(., aes(x=weekday, y=n, group=1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, "vd", "vd_crime_weekday_graph.jpeg"), dpi = 500)
```

```{r VD Crime by Weekday Graph Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "vd", "vd_crime_weekday_graph.jpeg"), dpi = 500)
```

## Vandeventer: Crimes by Time of Day

```{r VD Crime by Time of Day Graph Prep, include = FALSE }
monthCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(dayNight) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, "vd", "vd_crime_timeDay_graph.jpeg"), dpi = 500)
```

```{r VD Crime by Time of Day Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "vd", "vd_crime_timeDay_graph.jpeg"), dpi = 500)
```

## Vandeventer: Crimes by Day & Category

```{r VD Crime by Category Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 58) %>%
  group_by(crimeCatName) %>%
  ggplot(., aes(weekday)) +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, "vd", "vd_crimeCat_weekday_graph.jpeg"), dpi = 500)
```

```{r VD Crime by Category Weekday Graph Knit, echo = FALSE}
knitr::include_graphics(here("results", params$year, params$month, "vd", "vd_crimeCat_weekday_graph.jpeg"), dpi = 500)
```