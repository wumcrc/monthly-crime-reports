---
title: "Skinker DeBaliviere, DeBaliviere Place, West End, Visitation Park"
subtitle: "Monthly Crime report: March 2020" 
author: "Washington University Medical Center"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output:
  powerpoint_presentation
always_allow_html: yes
params:
  month: December
  abbr: Dec
  num: 12 #Month number
  pastyear: 2019
  year: 2020
  date: "2020-12-01"
  pastdate: "2019-12-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Dependencies and Data, include = FALSE}
# tidyverse packages
library(ggplot2)       # plotting data
library(stringr)       # wrappers for common string operations
library(tidyr)         # tidy data
library(dplyr)         # data manipulation
library(magrittr)      # pipe operator
library(readxl)        # read & write excel files
library(lubridate)     # time data manipulation
library(scales)

# spatial packages
library(tmap)         # map layouts
library(tmaptools)    # tools for handeling spatial
library(oldtmaptools) # deprecated toolds for spatial analysis
library(sf)           # spatial data tools
library(ceramic)      # download online imagery tiles
library(compstatr)    # tools for STL crime data
library(raster)       # geograpic data analysis & modeling

# other packages
library(here)         # file path management
library(janitor)      # tools for examining data
library(RColorBrewer) # cynthia brewer color palettes
library(viridis)      # color palettes
library(flextable)   # exporting pretty tables
library(htmltools)
library(knitr)
library(tibble)
library(rlang)
library(officer)      # powerpoint output
#devtools::install_github("davidgohel/officer")   # use github version until updates are made to CRAN
library(customLayout) # custom powerpoint layout
library(docxtractr)   #convert pptx to pdf


# load data
load(file = here("data", "basemap-files", "mapbox-tiles.rda"))
load(file = here("data", "basemap-files", "boundaries.rda"))
load(file = here("data", "crime-data.rda"))
load(file = here("data", "spatial-crime-data.rda"))
load(file = here("data", "nbhd_pop10.rda"))
load(file = here("data", "basemap-files", "nbhd-boundaries.rda"))

# create powerpoint
report <- read_pptx()
```

#Function References

`lay_new` creates a custom layout. You use the `matrix` argument to specify the location of figures.

`lay_bind_row` combines custom layouts. In this instance, we are combining the title layout with the body layout for our powerpoint slide.

`phl_layout` transforms your custom layout to an officer PowerPoint slide.

`fp_text` creates a font style for an officer powerpoint slide.

`ftext` creates a formatted chunk of text, often referencing `fp_text` for formatting instructions.

`fpar` creates formatted paragraphs in Powerpoint. Used to concatenate `ftext` objects into a paragraph.

`block_list` combines several blocks, or `fpar` objects, into a single object. Used to create formatted paragraphs in Powerpoint.

`read_pptx` creates a powerpoint presentation. You can use a variety of functions to add content to the presentation once the object is created.

`add_slide` adds a powerpoint slide to an existing powerpoint object. Specify what kind of layout you want the slide to be.

`ph_with` adds content to an existing powerpoint slide. This function often follows the `add_slide` function. This function is used to add everything from tables, to titles to body paragraphs on your powerpoint slide.

`sprintf` creates a character vector containing a formatted combination of text and variable values. In this notebook it is used for summary notes where it references the paramaters as well as certain variable values.

`filter` is a dplyr function that is used to clean data. Specifically it is used to find rows/cases where a condition is true. If the condition is true then the values are kept, if not they are dropped.

`group_by` takes an existing tbl and converts it into a grouped tbl based on a specific variable.

`rename` does exactly what you think it does. It renames variables based on name.

`replace` replaces a certain value with another. It is used in this notebook to replace NAs with 0.

`pivot_wider` increases the number of columns and decreases the number of rows. It is used in this notebook to widen the number of columns based on month. So the final output table has a column for each month of the year.

`add_row` adds a row to a dataframe. It is used to add rows to tables based on whether or not a specific crime was committed. So, if there were no arsons that month, the `add_row` function is used to add this crime with values of 0.

`arrange` sorts a variable in ascending order

`adorn_totals` adds a "totals" row or column to a data frame.


`colformat_num` formats numeric variables in a flextable. Specifically aimed at controlling the number of digits displayed.

`add_header_lines` adds a header to a flextable.

`autofit` is used to automatically adjust flextable height and width to fit the size of desired content.

`intersect` is used to figure out what columns and rows are shared between dataframes. 

`unlist` 

`cut` divides the unlisted dataframe into intervals and codes their values based on what interval the value falls into. This is how we color the flextables based on their values.

`bg` changes the background color of selected rows/columns in a flextable. We get these values from the `cut` function.

`height_all` sets the height of the flextable. This is used to fit the flextables on the powerpoint slide.

`phl_with_text` adds text to custom layout created via `phl_layout`.

`phl_with_flextable` adds flextable to custom layout created via `phl_layout`.

`is_empty` checks if an object has a value or not. If the value is missing, then we use `add_row` to add the missing crime.

`tm_shape` creates a tmap-element that draws polygons.

`tm_fill` fills map shapes based on what you want. You can either choose a fixed color or map create a color palette mapped to a variable.

`tm_border` adds borders to a map shape

`tm_credits` adds map credits.

`tm_bubbles` creates bubbles. This is how we represent crime points on a map.

`tm_layout` specifies map layout. Used for controlling/creating map legend

`which_min` `which_max` finds the location of the min/max of a vector. This is useful because it gives you the whole row where the min/max is as opposed to just the value of the lowest observation. This is beneficial in the District summaries because it tells us where a min/max value occurs (i.e. what neighborhood)

`ph_add_text` add text to a paragraph.

`ph_add_par` adds an empty paragraph to a powerpoint slide. This is used in the district summaries to create bullet points with only one level per paragraph.

`tmap_save` saves a tmap object.

`ggsave` saves a ggplot object.

`convert_to_pdf` uses libreOffice (another application) to convert the saved powerpoint into a PDF.

`ggplot`initializes a ggplot object. Can be used to specify the data frame and the plot aesthetics.

`geom_bar` creates a bar plot in a ggplot object

`geom_point` creates points in a ggplot object

`geom_line` creates a line plot in a ggplot object.

`scale_colour_manual` used to assign specific color values to ggplot. This references the `cols` vector to make sure that symbology is consistent throughout the report.

`xlab` `ylab` creates axis labels in a ggplot object.

```{r officer layout}
lay <- lay_new(matrix(1:4, nc = 2), widths = c(2,2), heights = c(2,1)) 
title <- lay_new(1, widths = 2, heights = 2)
layout <- lay_bind_row(title, lay, heights = c(1,6))
lay_show(layout)

lay01 <- lay_new(matrix(1:2)) 
title01 <- lay_new(1, widths = 2, heights = 2)
layout01 <- lay_bind_row(title01, lay01, heights = c(1,6))
lay_show(layout01)

## create officer layouts
offlayout <- phl_layout(layout,
    margins = c(0, 1, 1, 0),
    innerMargins = rep(0.15,4))

offlayout01 <- phl_layout(layout01,
    margins = c(0.25, 0.25, 0.25, 0.25),
    innerMargins = rep(0.15,4))
```

```{r Set column name keys for flextable, include = FALSE }
colkeys19 <- totalCrimes19$monthVar
colkeys20 <- ytdCrimes20$monthVar
colkeystotal <- c("Total")
part1crimes <- c("Aggravated Assault", "Arson", "Burgalry", "Homicide", "Larceny", "Motor Vehicle Theft", "Robbery", "Rape")
wkdys <- c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
#tmap_options()
```

```{r plot and text color palette, inlude = FALSE}
cols <- c("Aggravated Assault" = "#e41a1c", "Arson" = "#A65628", "Burgalry" = "#377eb8", 
          "Homicide" = "#FFFF33", "Larceny" = "#4DAF4A", "Motor Vehicle Theft" = "#984EA3", 
          "Robbery" = "#FF7F00") 

tf_cols <- c("TRUE" = "#DE2D26", "FALSE" = "#FEE0D2")

# summary note colors
reg24 <- fp_text(color = 'black', font.size = 24)
reg20 <- fp_text(color = 'black', font.size = 20)
boldline <- fp_text(color = "black", font.size = 28, bold = TRUE, underlined = TRUE)
bold <- fp_text(color = "black", font.size = 24, bold = TRUE)
```

```{r powerpoint title}
#title slide
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "Skinker DeBaliviere, DeBaliviere Place, West End, Visitation Park", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with(c(paste("Monthly Crime Report:", params$month, params$year, sep = " "), "Washington University Medical Center"), location = ph_location_type(type = "subTitle")) -> report
```

## Skinker DeBaliviere: Summary Notes

```{r SDB Summary Prep, include=FALSE}
tc19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 46,])
tc20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 46,])
cap19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 46 & monthCrimes19$crimeCatNum == 4 | monthCrimes19$neighborhood == 46 & monthCrimes19$crimeCatNum == 3,])
cap20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 46 & monthCrimes20$crimeCatNum == 4 | monthCrimes20$neighborhood == 46 & monthCrimes20$crimeCatNum == 3,])

tc_ytd19 <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 46,])
tc_ytdCurrent <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 46,])
cap19_ytd <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 46 & ytdCrimes19$crimeCatNum == 4 | ytdCrimes19$neighborhood == 46 & ytdCrimes19$crimeCatNum == 3,])
cap20_ytd <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 46 & ytdCrimes20$crimeCatNum == 4 | ytdCrimes20$neighborhood == 46 & ytdCrimes20$crimeCatNum == 3,])

pct_chg_mth1 <- (tc20 - tc19)/tc19
pct_chg_mth <- percent(pct_chg_mth1)
if(is.nan(pct_chg_mth1)){pct_chg_mth[is.nan(pct_chg_mth1)] <- 0}
if(is.infinite(pct_chg_mth1)){pct_chg_mth[is.infinite(pct_chg_mth1)] <- "Infinite"}

pct_chg_cap1 <- (cap20 - cap19)/cap19
pct_chg_cap <- percent(pct_chg_cap1)
if(is.nan(pct_chg_cap1)){pct_chg_cap[is.nan(pct_chg_cap1)] <- 0}
if(is.infinite(pct_chg_cap1)){pct_chg_cap[is.infinite(pct_chg_cap1)] <- "Infinite"}

pct_chg_ytd1 <- (tc_ytdCurrent - tc_ytd19)/tc_ytd19
pct_chg_ytd <- percent(pct_chg_ytd1)
if(is.nan(pct_chg_ytd1)){pct_chg_ytd[is.nan(pct_chg_ytd1)] <- 0}
if(is.infinite(pct_chg_ytd1)){pct_chg_ytd[is.infinite(pct_chg_ytd1)] <- "Infinite"}

pct_chg_ytd_cap1 <- (cap20_ytd - cap19_ytd)/cap19_ytd
pct_chg_ytd_cap <- percent(pct_chg_ytd_cap1)
if(is.nan(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.nan(pct_chg_ytd_cap1)] <- 0}
if(is.infinite(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.infinite(pct_chg_ytd_cap1)] <- "Infinite"}

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc20, params$month, params$year)
sprint_2 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_mth1 == 0, "#00B0F0", ifelse(pct_chg_mth < 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cap1 == 0, "#00B0F0", ifelse(pct_chg_cap < 0, "#00B050", "red")), font.size = 20)
color24b <- fp_text(color = ifelse(pct_chg_ytd1 == 0, '#00B0F0', ifelse(pct_chg_ytd < 0, '#00B050', 'red')), font.size = 24)
color20b <- fp_text(color = ifelse(pct_chg_ytd_cap1 == 0, "#00B0F0", ifelse(pct_chg_ytd_cap < 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_mth, "change ", sep = " "), color24a),
       ftext(paste("compared to ", params$month, " ", params$pastyear, " (", tc19, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap20, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$month, params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_cap, "change", sep = " "), color20a),
       ftext(paste(" compared to ", params$month, " ", params$pastyear, " (", cap19, " crimes against persons)", sep = ""), reg20)),
  fpar(ftext(sprint_2, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_ytd, "change ", sep = " "), color24b),
       ftext(paste("compared to this time in ", params$pastyear, " (", tc_ytd19, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap20_ytd, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_ytd_cap, "change", sep = " "), color20b),
       ftext(paste(" compared to this time in ", params$pastyear, " (", cap19_ytd, " crimes against persons)", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Skinker DeBaliviere: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report
```

## Skinker DeBaliviere: Year to Year Comparison

```{r SDB Year Comps Prep, include=FALSE}
totalCrimes19 %>%
  filter(., neighborhood == 46) %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> sdb_2019

ytdCrimes20 %>%
  filter(., neighborhood == 46) %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> sdb_2020
```

```{r SDB Total Crimes Flextable 2019, echo = FALSE}
part1crimes[!(part1crimes %in% sdb_2019$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(sdb_2019, crimeCatName = missing_category) -> sdb_2019
}

sdb_2019 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> sdb_2019

flextable(sdb_2019) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  add_header_lines(values = paste(params$pastyear))%>%
  autofit() -> flex
#Adjust flextable height to fit powerpoint slide
flex <- height_all(flex, height = .25, part = "all")
```

```{r SDB Total Crimes Flextable 2020, echo = FALSE}
part1crimes[!(part1crimes %in% sdb_2020$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(sdb_2020, crimeCatName = missing_category) -> sdb_2020
}

sdb_2020 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> sdb_2020

#compare dataframes and get common columns
common_cols <- intersect(colnames(sdb_2020[, (params$num + 1)]), colnames(sdb_2019[, (params$num + 1)]))

#assign to temporary dataframe
temp19 <- sdb_2019[,common_cols, drop=FALSE]
temp20 <- sdb_2020[,common_cols, drop=FALSE]

#assign colors, green is a decrease in crime, red is an increase, transparent is no change
colors <- unlist(temp20 - temp19)%>%
  cut(breaks = c(-Inf, -.1, 0.1, Inf),
      labels = c("lightgreen", "transparent", "lightcoral")) %>% 
  as.character()
#make flextable, color all columns except the first
flextable(sdb_2020) %>% 
  bg(j = params$abbr, bg = colors) %>% 
  add_header_lines(values = paste(params$year))%>%
  autofit() -> flex01
#Adjust flextable height to fit powerpoint slide
flex01 <- height_all(flex01, height = .25, part = "all")
# add powerpoint slide
report%>%
  add_slide()%>%
  phl_with_text(olay = offlayout01, 1, "Skinker DeBaliviere: Year to Year Comparison")%>%
  phl_with_flextable(olay = offlayout01, 2, flex)%>%
  phl_with_flextable(olay = offlayout01, 3, flex01) -> report
```


## Skinker DeBaliviere: Summary Tables

```{r SDB Tables Prep, include = FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 46) %>%
  group_by(crimeCatName) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> sdb_crimeCat

monthCrimes20 %>%
  filter(., neighborhood == 46) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> sdb_weekDay

wkdys[!(wkdys %in% sdb_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(sdb_weekDay) -> sdb_weekDay

if(test == FALSE) {
   add_row(sdb_weekDay, weekday = missing_category_days) -> sdb_weekDay
}

sdb_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> sdb_weekDay

monthCrimes20 %>%
  filter(., neighborhood == 46) %>%
  group_by(violent) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> sdb_violent

monthCrimes20 %>%
  filter(., neighborhood == 46) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> sdb_dayNight
```

```{r SDB Flextables Knit, echo = FALSE}
flextable(sdb_crimeCat) %>%
  autofit() -> flex01

flextable(sdb_weekDay) %>%
  autofit() -> flex02

flextable(sdb_violent) %>%
  autofit() -> flex03

flextable(sdb_dayNight) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with("Skinker DeBaliviere: Summary Tables", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 4, flex01)%>%
  phl_with_flextable(olay = offlayout, 2, flex02)%>%
  phl_with_flextable(olay = offlayout, 3, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report
```

## Skinker DeBaliviere: Total Crime Map

```{r SDB color palette, include = FALSE}
sub <- filter(monthCrimes20_sf, neighborhood == 46)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
```

```{r SDB Total Crime Prep, include = FALSE}
tm_shape(sdb_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 46) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 46) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> sdb_total_tm

tmap_save(sdb_total_tm, file = here("results", params$year, params$month, "sdb", "sdb_total_tm.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "sdb", "sdb_total_tm.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere: Total Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## DeBaliviere Place: Summary Notes

```{r DBP Summary Prep, include=FALSE}
tc19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 47,])
tc20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 47,])
cap19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 47 & monthCrimes19$crimeCatNum == 4 | monthCrimes19$neighborhood == 47 & monthCrimes19$crimeCatNum == 3,])
cap20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 47 & monthCrimes20$crimeCatNum == 4 | monthCrimes20$neighborhood == 47 & monthCrimes20$crimeCatNum == 3,])

tc_ytd19 <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 47,])
tc_ytdCurrent <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 47,])
cap19_ytd <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 47 & ytdCrimes19$crimeCatNum == 4 | ytdCrimes19$neighborhood == 47 & ytdCrimes19$crimeCatNum == 3,])
cap20_ytd <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 47 & ytdCrimes20$crimeCatNum == 4 | ytdCrimes20$neighborhood == 47 & ytdCrimes20$crimeCatNum == 3,])

pct_chg_mth1 <- (tc20 - tc19)/tc19
pct_chg_mth <- percent(pct_chg_mth1)
if(is.nan(pct_chg_mth1)){pct_chg_mth[is.nan(pct_chg_mth1)] <- 0}
if(is.infinite(pct_chg_mth1)){pct_chg_mth[is.infinite(pct_chg_mth1)] <- "Infinite"}

pct_chg_cap1 <- (cap20 - cap19)/cap19
pct_chg_cap <- percent(pct_chg_cap1)
if(is.nan(pct_chg_cap1)){pct_chg_cap[is.nan(pct_chg_cap1)] <- 0}
if(is.infinite(pct_chg_cap1)){pct_chg_cap[is.infinite(pct_chg_cap1)] <- "Infinite"}

pct_chg_ytd1 <- (tc_ytdCurrent - tc_ytd19)/tc_ytd19
pct_chg_ytd <- percent(pct_chg_ytd1)
if(is.nan(pct_chg_ytd1)){pct_chg_ytd[is.nan(pct_chg_ytd1)] <- 0}
if(is.infinite(pct_chg_ytd1)){pct_chg_ytd[is.infinite(pct_chg_ytd1)] <- "Infinite"}

pct_chg_ytd_cap1 <- (cap20_ytd - cap19_ytd)/cap19_ytd
pct_chg_ytd_cap <- percent(pct_chg_ytd_cap1)
if(is.nan(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.nan(pct_chg_ytd_cap1)] <- 0}
if(is.infinite(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.infinite(pct_chg_ytd_cap1)] <- "Infinite"}

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc20, params$month, params$year)
sprint_2 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_mth1 == 0, "#00B0F0", ifelse(pct_chg_mth < 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cap1 == 0, "#00B0F0", ifelse(pct_chg_cap < 0, "#00B050", "red")), font.size = 20)
color24b <- fp_text(color = ifelse(pct_chg_ytd1 == 0, '#00B0F0', ifelse(pct_chg_ytd < 0, '#00B050', 'red')), font.size = 24)
color20b <- fp_text(color = ifelse(pct_chg_ytd_cap1 == 0, "#00B0F0", ifelse(pct_chg_ytd_cap < 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_mth, "change ", sep = " "), color24a),
       ftext(paste("compared to ", params$month, " ", params$pastyear, " (", tc19, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap20, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$month, params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_cap, "change", sep = " "), color20a),
       ftext(paste(" compared to ", params$month, " ", params$pastyear, " (", cap19, " crimes against persons)", sep = ""), reg20)),
  fpar(ftext(sprint_2, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_ytd, "change ", sep = " "), color24b),
       ftext(paste("compared to this time in ", params$pastyear, " (", tc_ytd19, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap20_ytd, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_ytd_cap, "change", sep = " "), color20b),
       ftext(paste(" compared to this time in ", params$pastyear, " (", cap19_ytd, " crimes against persons)", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "DeBaliviere Place: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report
```

## DeBaliviere Place: Year to Year Comparison

```{r DBP Year Comps Prep, include=FALSE}
totalCrimes19 %>%
  filter(., neighborhood == 47) %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> dbp_2019

ytdCrimes20 %>%
  filter(., neighborhood == 47) %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> dbp_2020
```

```{r DBP Total Crimes Flextable 2019, echo = FALSE}
part1crimes[!(part1crimes %in% dbp_2019$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(dbp_2019, crimeCatName = missing_category) -> dbp_2019
}

dbp_2019 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> dbp_2019

flextable(dbp_2019) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  add_header_lines(values = paste(params$pastyear))%>%
  autofit() -> flex
#Adjust flextable height to fit powerpoint slide
flex <- height_all(flex, height = .25, part = "all")
```

```{r dbp Total Crimes Flextable 2020, echo = FALSE}
part1crimes[!(part1crimes %in% dbp_2020$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(dbp_2020, crimeCatName = missing_category) -> dbp_2020
}

dbp_2020 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> dbp_2020

#compare dataframes and get common columns
common_cols <- intersect(colnames(sdb_2020[, (params$num + 1)]), colnames(sdb_2019[, (params$num + 1)]))

#assign to temporary dataframe
temp19 <- dbp_2019[,common_cols, drop=FALSE]
temp20 <- dbp_2020[,common_cols, drop=FALSE]

#assign colors, green is a decrease in crime, red is an increase, transparent is no change
colors <- unlist(temp20 - temp19)%>%
  cut(breaks = c(-Inf, -.1, 0.1, Inf),
      labels = c("lightgreen", "transparent", "lightcoral")) %>% 
  as.character()
#make flextable, color all columns except the first
flextable(dbp_2020) %>% 
  bg(j = params$abbr, bg = colors) %>% 
  add_header_lines(values = paste(params$year))%>%
  autofit() -> flex01
#Adjust flextable height to fit powerpoint slide
flex01 <- height_all(flex01, height = .25, part = "all")

# add powerpoint slide
report%>%
  add_slide()%>%
  phl_with_text(olay = offlayout01, 1, "DeBaliviere Place: Year to Year Comparison")%>%
  phl_with_flextable(olay = offlayout01, 2, flex)%>%
  phl_with_flextable(olay = offlayout01, 3, flex01) -> report
```

## DeBaliviere Place: Summary Tables

```{r DBP Tables Prep, include = FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 47) %>%
  group_by(crimeCatName) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> dbp_crimeCat

monthCrimes20 %>%
  filter(., neighborhood == 47) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> dbp_weekDay

wkdys[!(wkdys %in% dbp_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(dbp_weekDay) -> dbp_weekDay

if(test == FALSE) {
   add_row(dbp_weekDay, weekday = missing_category_days) -> dbp_weekDay
}

dbp_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> dbp_weekDay

monthCrimes20 %>%
  filter(., neighborhood == 47) %>%
  group_by(violent) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> dbp_violent


monthCrimes20 %>%
  filter(., neighborhood == 47) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> dbp_dayNight
```

```{r DBP Flextables Knit, echo = FALSE}
flextable(dbp_crimeCat) %>%
  autofit() -> flex01

flextable(dbp_weekDay) %>%
  autofit() -> flex02

flextable(dbp_violent) %>%
  autofit() -> flex03

flextable(dbp_dayNight) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with("DeBaliviere Place: Summary Tables", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 4, flex01)%>%
  phl_with_flextable(olay = offlayout, 2, flex02)%>%
  phl_with_flextable(olay = offlayout, 3, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report
```

## DeBaliviere Place: Total Crime Map

```{r DBP color palette, include = FALSE}
sub <- filter(monthCrimes20_sf, neighborhood == 47)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
```

```{r DBP Total Crime Prep, include = FALSE}
tm_shape(dbp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 47) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 47) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> dbp_total_tm

tmap_save(dbp_total_tm, file = here("results", params$year, params$month, "dbp", "dbp_total_crimes.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "dbp", "dbp_total_crimes.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place: Total Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Summary Notes: West End

```{r WE Summary Notes Prep, include=FALSE}
tc19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 48,])
tc20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 48,])
cap19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 48 & monthCrimes19$crimeCatNum == 4 | monthCrimes19$neighborhood == 48 & monthCrimes19$crimeCatNum == 3,])
cap20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 48 & monthCrimes20$crimeCatNum == 4 | monthCrimes20$neighborhood == 48 & monthCrimes20$crimeCatNum == 3,])

tc_ytd19 <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 48,])
tc_ytdCurrent <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 48,])
cap19_ytd <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 48 & ytdCrimes19$crimeCatNum == 4 | ytdCrimes19$neighborhood == 48 & ytdCrimes19$crimeCatNum == 3,])
cap20_ytd <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 48 & ytdCrimes20$crimeCatNum == 4 | ytdCrimes20$neighborhood == 48 & ytdCrimes20$crimeCatNum == 3,])

pct_chg_mth1 <- (tc20 - tc19)/tc19
pct_chg_mth <- percent(pct_chg_mth1)
if(is.nan(pct_chg_mth1)){pct_chg_mth[is.nan(pct_chg_mth1)] <- 0}
if(is.infinite(pct_chg_mth1)){pct_chg_mth[is.infinite(pct_chg_mth1)] <- "Infinite"}

pct_chg_cap1 <- (cap20 - cap19)/cap19
pct_chg_cap <- percent(pct_chg_cap1)
if(is.nan(pct_chg_cap1)){pct_chg_cap[is.nan(pct_chg_cap1)] <- 0}
if(is.infinite(pct_chg_cap1)){pct_chg_cap[is.infinite(pct_chg_cap1)] <- "Infinite"}

pct_chg_ytd1 <- (tc_ytdCurrent - tc_ytd19)/tc_ytd19
pct_chg_ytd <- percent(pct_chg_ytd1)
if(is.nan(pct_chg_ytd1)){pct_chg_ytd[is.nan(pct_chg_ytd1)] <- 0}
if(is.infinite(pct_chg_ytd1)){pct_chg_ytd[is.infinite(pct_chg_ytd1)] <- "Infinite"}

pct_chg_ytd_cap1 <- (cap20_ytd - cap19_ytd)/cap19_ytd
pct_chg_ytd_cap <- percent(pct_chg_ytd_cap1)
if(is.nan(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.nan(pct_chg_ytd_cap1)] <- 0}
if(is.infinite(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.infinite(pct_chg_ytd_cap1)] <- "Infinite"}

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc20, params$month, params$year)
sprint_2 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_mth1 == 0, "#00B0F0", ifelse(pct_chg_mth < 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cap1 == 0, "#00B0F0", ifelse(pct_chg_cap < 0, "#00B050", "red")), font.size = 20)
color24b <- fp_text(color = ifelse(pct_chg_ytd1 == 0, '#00B0F0', ifelse(pct_chg_ytd < 0, '#00B050', 'red')), font.size = 24)
color20b <- fp_text(color = ifelse(pct_chg_ytd_cap1 == 0, "#00B0F0", ifelse(pct_chg_ytd_cap < 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_mth, "change ", sep = " "), color24a),
       ftext(paste("compared to ", params$month, " ", params$pastyear, " (", tc19, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap20, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$month, params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_cap, "change", sep = " "), color20a),
       ftext(paste(" compared to ", params$month, " ", params$pastyear, " (", cap19, " crimes against persons)", sep = ""), reg20)),
  fpar(ftext(sprint_2, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_ytd, "change ", sep = " "), color24b),
       ftext(paste("compared to this time in ", params$pastyear, " (", tc_ytd19, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap20_ytd, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_ytd_cap, "change", sep = " "), color20b),
       ftext(paste(" compared to this time in ", params$pastyear, " (", cap19_ytd, " crimes against persons)", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "West End: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report
```

## West End: Year to Year Comparison

```{r we Year Comps Prep, include=FALSE}
totalCrimes19 %>%
  filter(., neighborhood == 48) %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> we_2019

ytdCrimes20 %>%
  filter(., neighborhood == 48) %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> we_2020
```

```{r WE Total Crimes Flextable 2019, echo = FALSE}
part1crimes[!(part1crimes %in% we_2019$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(we_2019, crimeCatName = missing_category) -> we_2019
}

we_2019 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> we_2019

flextable(we_2019) %>%
  colformat_num(., digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  add_header_lines(values = paste(params$pastyear))%>%
  autofit() -> flex
#Adjust flextable height to fit powerpoint slide
flex <- height_all(flex, height = .25, part = "all")
```

```{r we Total Crimes Flextable 2020, echo = FALSE}
part1crimes[!(part1crimes %in% we_2020$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(we_2020, crimeCatName = missing_category) -> we_2020
}

we_2020 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> we_2020

#compare dataframes and get common columns
common_cols <- intersect(colnames(we_2020[, (params$num + 1)]), colnames(we_2019[, (params$num + 1)]))

#assign to temporary dataframe
temp19 <- we_2019[,common_cols, drop=FALSE]
temp20 <- we_2020[,common_cols, drop=FALSE]

#assign colors, green is a decrease in crime, red is an increase, transparent is no change
colors <- unlist(temp20 - temp19)%>%
  cut(breaks = c(-Inf, -.1, 0.1, Inf),
      labels = c("lightgreen", "transparent", "lightcoral")) %>% 
  as.character()
#make flextable, color all columns except the first
flextable(we_2020) %>% 
  bg(j = params$abbr, bg = colors) %>% 
  add_header_lines(values = paste(params$year))%>%
  autofit() -> flex01
#Adjust flextable height to fit powerpoint slide
flex01 <- height_all(flex01, height = .25, part = "all")

# add powerpoint slide
report%>%
  add_slide()%>%
  ph_with("West End: Year to Year Comparison", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout01, 2, flex)%>%
  phl_with_flextable(olay = offlayout01, 3, flex01) -> report
```

## West End: Summary Tables

```{r WE Tables Prep, include = FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 48) %>%
  group_by(crimeCatName) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> we_crimeCat

monthCrimes20 %>%
  filter(., neighborhood == 48) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> we_weekDay

wkdys[!(wkdys %in% we_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(we_weekDay) -> we_weekDay

if(test == FALSE) {
   add_row(we_weekDay, weekday = missing_category_days) -> we_weekDay
}

we_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> we_weekDay

monthCrimes20 %>%
  filter(., neighborhood == 48) %>%
  group_by(violent) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> we_violent

monthCrimes20 %>%
  filter(., neighborhood == 48) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> we_dayNight

```

```{r WE Flextables Knit, echo = FALSE}
flextable(we_crimeCat) %>%
  autofit() -> flex01

flextable(we_weekDay) %>%
  autofit() -> flex02

flextable(we_violent) %>%
  autofit() -> flex03

flextable(we_dayNight) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with("West End: Summary Tables", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 4, flex01)%>%
  phl_with_flextable(olay = offlayout, 2, flex02)%>%
  phl_with_flextable(olay = offlayout, 3, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report
```

## West End: Total Crime Map

```{r Academy color palette, include = FALSE}
sub <- filter(monthCrimes20_sf, neighborhood == 48)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
```

```{r WE Total Crime Prep, include = FALSE}
tm_shape(we_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 48) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 48) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> we_total_tm

tmap_save(we_total_tm, file = here("results", params$year, params$month, "we", "we_total_crimes.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "we", "we_total_crimes.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End: Total Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Visitation Park: Summary Notes

```{r VP Summary Prep, include=FALSE}
tc19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 49,])
tc20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 49,])
cap19 <- nrow(monthCrimes19[monthCrimes19$neighborhood == 49 & monthCrimes19$crimeCatNum == 4 | monthCrimes19$neighborhood == 49 & monthCrimes19$crimeCatNum == 3,])
cap20 <- nrow(monthCrimes20[monthCrimes20$neighborhood == 49 & monthCrimes20$crimeCatNum == 4 | monthCrimes20$neighborhood == 49 & monthCrimes20$crimeCatNum == 3,])

tc_ytd19 <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 49,])
tc_ytdCurrent <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 49,])
cap19_ytd <- nrow(ytdCrimes19[ytdCrimes19$neighborhood == 49 & ytdCrimes19$crimeCatNum == 4 | ytdCrimes19$neighborhood == 49 & ytdCrimes19$crimeCatNum == 3,])
cap20_ytd <- nrow(ytdCrimes20[ytdCrimes20$neighborhood == 49 & ytdCrimes20$crimeCatNum == 4 | ytdCrimes20$neighborhood == 49 & ytdCrimes20$crimeCatNum == 3,])

pct_chg_mth1 <- (tc20 - tc19)/tc19
pct_chg_mth <- percent(pct_chg_mth1)
if(is.nan(pct_chg_mth1)){pct_chg_mth[is.nan(pct_chg_mth1)] <- 0}
if(is.infinite(pct_chg_mth1)){pct_chg_mth[is.infinite(pct_chg_mth1)] <- "Infinite"}

pct_chg_cap1 <- (cap20 - cap19)/cap19
pct_chg_cap <- percent(pct_chg_cap1)
if(is.nan(pct_chg_cap1)){pct_chg_cap[is.nan(pct_chg_cap1)] <- 0}
if(is.infinite(pct_chg_cap1)){pct_chg_cap[is.infinite(pct_chg_cap1)] <- "Infinite"}

pct_chg_ytd1 <- (tc_ytdCurrent - tc_ytd19)/tc_ytd19
pct_chg_ytd <- percent(pct_chg_ytd1)
if(is.nan(pct_chg_ytd1)){pct_chg_ytd[is.nan(pct_chg_ytd1)] <- 0}
if(is.infinite(pct_chg_ytd1)){pct_chg_ytd[is.infinite(pct_chg_ytd1)] <- "Infinite"}

pct_chg_ytd_cap1 <- (cap20_ytd - cap19_ytd)/cap19_ytd
pct_chg_ytd_cap <- percent(pct_chg_ytd_cap1)
if(is.nan(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.nan(pct_chg_ytd_cap1)] <- 0}
if(is.infinite(pct_chg_ytd_cap1)){pct_chg_ytd_cap[is.infinite(pct_chg_ytd_cap1)] <- "Infinite"}

sprint_1 <- sprintf("%s total crimes in %s %s", 
                    tc20, params$month, params$year)
sprint_2 <- sprintf("%s total crimes in %s", 
                    tc_ytdCurrent, params$year)

# text formatting
color24a <- fp_text(color = ifelse(pct_chg_mth1 == 0, "#00B0F0", ifelse(pct_chg_mth < 0, "#00B050", "red")), font.size = 24)
color20a <- fp_text(color = ifelse(pct_chg_cap1 == 0, "#00B0F0", ifelse(pct_chg_cap < 0, "#00B050", "red")), font.size = 20)
color24b <- fp_text(color = ifelse(pct_chg_ytd1 == 0, '#00B0F0', ifelse(pct_chg_ytd < 0, '#00B050', 'red')), font.size = 24)
color20b <- fp_text(color = ifelse(pct_chg_ytd_cap1 == 0, "#00B0F0", ifelse(pct_chg_ytd_cap < 0, "#00B050", "red")), font.size = 20)
  

# create summary notes
summary <- block_list(
  fpar(ftext(sprint_1, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_mth, "change ", sep = " "), color24a),
       ftext(paste("compared to ", params$month, " ", params$pastyear, " (", tc19, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap20, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$month, params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_cap, "change", sep = " "), color20a),
       ftext(paste(" compared to ", params$month, " ", params$pastyear, " (", cap19, " crimes against persons)", sep = ""), reg20)),
  fpar(ftext(sprint_2, boldline)),
  fpar(ftext(paste(" ", sep = ""), reg24),
       ftext(paste(pct_chg_ytd, "change ", sep = " "), color24b),
       ftext(paste("compared to this time in ", params$pastyear, " (", tc_ytd19, " total crimes)", sep = ""), reg24)),
  fpar(ftext(paste(cap20_ytd, "crime(s) against persons", sep = " "), bold),
       ftext(paste(" in", params$year, sep = " "), reg24)),
  fpar(ftext(paste(" ", sep = ""), reg20),
       ftext(paste(pct_chg_ytd_cap, "change", sep = " "), color20b),
       ftext(paste(" compared to this time in ", params$pastyear, " (", cap19_ytd, " crimes against persons)", sep = ""), reg20))
)

# write summary notes to powerpoint slide
report%>%
  add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "Visitation Park: Summary Notes", location = ph_location_type(type = "title"))%>%
  ph_with(summary, location = ph_location_type(type = "body"), is_list = TRUE, level_list = c(1, 2, 2, 3, 1, 2, 2, 3)) -> report
```

## Visitation Park: Year to Year Comparison

```{r vp Year Comps Prep, include=FALSE}
totalCrimes19 %>%
  filter(., neighborhood == 49) %>%
  group_by(monthVar, .drop = FALSE) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0)  -> vp_2019

ytdCrimes20 %>%
  filter(., neighborhood == 49) %>%
  group_by(monthVar) %>%
  count(crimeCatName) %>%
  rename(., "Number of Crimes" = n) %>%
  pivot_wider(names_from = monthVar, values_from = "Number of Crimes") %>%
  replace(., is.na(.), 0) -> vp_2020
```

```{r vp Total Crimes Flextable 2019, echo = FALSE}
part1crimes[!(part1crimes %in% vp_2019$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(vp_2019, crimeCatName = missing_category) -> vp_2019
}

vp_2019 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> vp_2019

flextable(vp_2019) %>%
  colformat_num(.,  digits = 0) %>%
  colformat_num(.,  digits = 0) %>%
  add_header_lines(values = paste(params$pastyear))%>%
  autofit() -> flex
#Adjust flextable height to fit powerpoint slide
flex <- height_all(flex, height = .25, part = "all")
```

```{r vp Total Crimes Flextable 2020, echo = FALSE}
part1crimes[!(part1crimes %in% vp_2020$crimeCatName)] -> missing_category
is_empty(missing_category) -> test

if(test == FALSE) {
   add_row(vp_2020, crimeCatName = missing_category) -> vp_2020
}

vp_2020 %>% 
  arrange(., crimeCatName) %>%
  replace(., is.na(.), 0) %>%
  adorn_totals(., "col", name = "Total") %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Part 1 Crimes" = crimeCatName) -> vp_2020

#compare dataframes and get common columns
common_cols <- intersect(colnames(vp_2020[, (params$num + 1)]), colnames(vp_2019[, (params$num + 1)]))

#assign to temporary dataframe
temp19 <- vp_2019[,common_cols, drop=FALSE]
temp20 <- vp_2020[,common_cols, drop=FALSE]

#assign colors, green is a decrease in crime, red is an increase, transparent is no change
colors <- unlist(temp20 - temp19)%>%
  cut(breaks = c(-Inf, -.1, 0.1, Inf),
      labels = c("lightgreen", "transparent", "lightcoral")) %>% 
  as.character()
#make flextable, color all columns except the first
flextable(vp_2020) %>% 
  bg(j = params$abbr, bg = colors) %>% 
  add_header_lines(values = paste(params$year))%>%
  autofit() -> flex01
#Adjust flextable height to fit powerpoint slide
flex01 <- height_all(flex01, height = .25, part = "all")

# add powerpoint slide
report%>%
  add_slide()%>%
  phl_with_text(olay = offlayout01, 1, "Visitation Park: Year to Year Comparison")%>%
  phl_with_flextable(olay = offlayout01, 2, flex)%>%
  phl_with_flextable(olay = offlayout01, 3, flex01) -> report
```

## Visitation Park: Summary Tables

```{r VP Tables Prep, include = FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 49) %>%
  group_by(crimeCatName) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Part 1 Crimes" = crimeCatName) -> vp_crimeCat

monthCrimes20 %>%
  filter(., neighborhood == 49) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  rename(., "Number of Crimes" = n) %>%
  replace(., is.na(.), 0) -> vp_weekDay

wkdys[!(wkdys %in% vp_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(vp_weekDay) -> vp_weekDay

if(test == FALSE) {
   add_row(vp_weekDay, weekday = missing_category_days) -> vp_weekDay
}

vp_weekDay %>% 
  replace(., is.na(.), 0) %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Day of the Week" = weekday) -> vp_weekDay

monthCrimes20 %>%
  filter(., neighborhood == 49) %>%
  group_by(violent) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Crimes Against Persons" = violent) -> vp_violent

monthCrimes20 %>%
  filter(., neighborhood == 49) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> vp_dayNight

```

```{r VP Flextables Knit, echo = FALSE}
flextable(vp_crimeCat) %>%
  autofit() -> flex01

flextable(vp_weekDay) %>%
  autofit() -> flex02

flextable(vp_violent) %>%
  autofit() -> flex03

flextable(vp_dayNight) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with("Visitation Park: Summary Tables", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 4, flex01)%>%
  phl_with_flextable(olay = offlayout, 2, flex02)%>%
  phl_with_flextable(olay = offlayout, 3, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report
```

## Visitation Park: Total Crime Map

```{r VP color palette, include = FALSE}
sub <- filter(monthCrimes20_sf, neighborhood == 49)
col <- character(0)
if("Aggravated Assault" %in% sub$crimeCatName){col <- c("Aggravated Assault" = "#e41a1c")}
if("Arson" %in% sub$crimeCatName){col <- c(col, "Arson" = "#A65628")}
if("Burgalry" %in% sub$crimeCatName){col <- c(col, "Burgalry" = "#377eb8")}
if("Homicide" %in% sub$crimeCatName){col <- c(col, "Homicide" = "#FFFF33")}
if("Larceny" %in% sub$crimeCatName){col <- c(col, "Larceny" = "#4DAF4A")}
if("Motor Vehicle Theft" %in% sub$crimeCatName){col <- c(col, "Motor Vehicle Theft" = "#984EA3")}
if("Robbery" %in% sub$crimeCatName){col <- c(col, "Robbery" = "#FF7F00")}
```

```{r VP Total Crime Prep, include = FALSE}
tm_shape(vp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 49) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 49) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "crimeCatName",
               palette = col,
               title.col = "Part 1 Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom")) -> vp_total_tm

tmap_save(vp_total_tm, file = here("results", params$year, params$month, "vp", "vp_total_tm.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vp", "vp_total_tm.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Visitation Park: Total Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## District 5: Crime Rates Map

```{r District 5 Density Map, echo = FALSE}
#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "district-5", "dst5_rates.jpeg"), width = 9, height = 5), location = ph_location_type(type="body"), use_loc_size = FALSE)%>%
  ph_with("District 5: Crime Rates Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r District 5 Density Map Explanation Prep, include = FALSE}
library(qwraps2)
options(qwraps2_markup = "markdown")

dst_5_pop_sf <- as.data.frame(dst_5_pop_sf)
summary_statistics <-
  list(
    "Crime Rates" =
      list(
        "mean" = ~mean(crimeRate, na_rm = TRUE),
        "min" = ~min(crimeRate, na.rm = TRUE),
        "max" = ~max(crimeRate, na.rm = TRUE)),
    "Crime Total" =
      list(
        "mean" = ~mean(crimeTotal, na_rm = TRUE),
        "min" = ~min(crimeTotal, na.rm = TRUE),
        "max" = ~max(crimeTotal, na.rm = TRUE)))

dst_5_table <- summary_table(dst_5_pop_sf, summary_statistics)

print(dst_5_table,
      cnames = "Summary Statistics")

dst_5_rate_mean <- mean(dst_5_pop_sf$crimeRate)
dst_5_rate_mean

dst_5_min <- dst_5_pop_sf[which.min(dst_5_pop_sf$crimeRate),]
dst_5_min_rate_nhd <- print(dst_5_min$NHD_NAME, max.levels = 0)
dst_5_min_rate <- print(dst_5_min$crimeRate, max.levels = 0)

dst_5_max <- dst_5_pop_sf[which.max(dst_5_pop_sf$crimeRate),]
dst_5_max_rate_nhd <- print(dst_5_max$NHD_NAME, max.levels = 0)
dst_5_max_rate <- print(dst_5_max$crimeRate, max.levels = 0)

dst_5_total_mean <- mean(dst_5_pop_sf$crimeTotal)
dst_5_total_mean

dst_5_minT <- dst_5_pop_sf[which.min(dst_5_pop_sf$crimeTotal),]
dst_5_min_tot_nhd <- print(dst_5_minT$NHD_NAME, max.levels = 0)
dst_5_min_tot <- print(dst_5_minT$crimeTotal, max.levels = 0)

dst_5_maxT <- dst_5_pop_sf[which.max(dst_5_pop_sf$crimeTotal),]
dst_5_max_tot_nhd <- print(dst_5_maxT$NHD_NAME, max.levels = 0)
dst_5_max_tot <- print(dst_5_maxT$crimeTotal, max.levels = 0)

# add to powerpoint
report%>%
    add_slide(layout = 'Title and Content', master = 'Office Theme')%>%
  ph_with(value = "District 5: Density Map Explanation", location = ph_location_type(type = "title"))%>%
    ph_with(block_list(fpar(ftext("There are 15 neighborhoods in District 5", fp_text(color = "black", font.size = 24)))), location = ph_location_type(type = "body"))%>%
    ph_add_par()%>%
    ph_add_text(str = paste(" in one neighborhood was ", dst_5_min_tot, " (", dst_5_min_tot_nhd, ")", sep = ""), style = fp_text(color = "black", font.size = 24)) %>%
    ph_add_text(str = "The minimum number of crimes ", 
                style = fp_text(color = "#00B050", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", dst_5_max_tot, " (", dst_5_max_tot_nhd, ")", sep = ""), style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The maximum number of crimes ",
                style = fp_text(color = "red", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was", round(dst_5_total_mean, digits = 2), 
                            sep = " "), style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The mean number of crimes ",
                style = fp_text(color = "#00B0F0", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", round(dst_5_min_rate, digits = 2), " (", dst_5_min_rate_nhd, ")", sep = ""),
                style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The minimum rate of crimes ",
                style = fp_text(color = "#00B050", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was ", round(dst_5_max_rate, digits = 2), " (", dst_5_max_rate_nhd, ")", sep = ""),
                style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The maximum rate of crimes ",
                style = fp_text(color = "red", font.size = 24))%>%
    ph_add_par()%>%
    ph_add_text(str = paste("in one neighborhood was", round(dst_5_rate_mean, digits = 2), 
                            sep = " "), style = fp_text(color = "black", font.size = 24))%>%
    ph_add_text(str = "The mean rate of crimes ",
                style = fp_text(color = "#00B0F0", font.size = 24)) -> report
```

## Skinker DeBaliviere: Neighborhood Detail
### Appendix 1

```{r}
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "Skinker DeBaliviere: Neighborhood Detail", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with("Appendix 1", location = ph_location_type(type = "subTitle")) -> report
```

## Skinker DeBaliviere: Time of Crimes Map

```{r SDB Day & Night Prep, include = FALSE}
sdb_dn_tm <- tm_shape(sdb_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 46) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 46) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(sdb_dn_tm, file = here("results", params$year, params$month, "sdb", "sdb_day_night.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "sdb", "sdb_day_night.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere: Time of Crimes Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Skinker DeBaliviere: Violent Crime Map

```{r SDB Violent Crime Map Prep, include = FALSE}
sdb_vlnt_tm <- tm_shape(sdb_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 46) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 46) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "violent",
               palette = tf_cols,
               title.col = "Violent") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(sdb_vlnt_tm, file = here("results", params$year, params$month, "sdb", "sdb_vlnt.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "sdb", "sdb_vlnt.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere: Violent Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Skinker DeBaliviere: Crime Density Map

```{r SDB Density Map Prep, eval = FALSE}
monthCrimes20_sf %>%
  filter(neighborhood == 46) %>%
  smooth_map(., bandwidth = 0.5, style = "pretty",
  cover = sdb) -> sdb_densities

sdb_den_tm <- tm_shape(sdb_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 46) %>%
  tm_shape() +
    tm_fill(col = NA,
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(sdb_densities$polygons) +
  tm_fill(col = "level", palette = "BuPu", alpha = .60,
    title = expression("Crimes per " * km^2)) +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(sdb_den_tm, file = here("results", params$year, params$month, "sdb", "sdb_density.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "sdb", "sdb_density.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere: Crime Density Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Skinker DeBaliviere: Larceny Breakdown

```{r SDB Larceny Breakdown Prep, include = FALSE}
larceny %>%
  filter(., neighborhood == 46) %>%
  group_by(weekday) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> sdb_larcenies_weekDay

larceny %>%
  filter(., neighborhood == 46) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> sdb_larcenies_dayNight

larceny %>%
  filter(., neighborhood == 46) %>%
  group_by(type) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> sdb_larcenies_type

larceny %>%
  filter(., neighborhood == 46) %>%
  group_by(value) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> sdb_larcenies_value
```

```{r SDB Larceny Tables Knit, echo = FALSE}
flextable(sdb_larcenies_weekDay) %>%
  autofit() -> flex01

flextable(sdb_larcenies_dayNight) %>%
  autofit() -> flex02

flextable(sdb_larcenies_type) %>%
  autofit() -> flex03

flextable(sdb_larcenies_value) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with("Skinker DeBaliviere: Larceny Breakdown", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 2, flex01)%>%
  phl_with_flextable(olay = offlayout, 3, flex02)%>%
  phl_with_flextable(olay = offlayout, 4, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report
```

## Skinker DeBaliviere: Total Crimes by Days of the Week

```{r SDB Crime by Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 46) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> sdb_weekDay

wkdys[!(wkdys %in% sdb_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(sdb_weekDay) -> sdb_weekDay

if(test == FALSE) {
   add_row(sdb_weekDay, weekday = missing_category_days) -> sdb_weekDay
}

  ggplot(sdb_weekDay, aes(x=weekday, y=n, group = 1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, "sdb", "sdb_crime_weekday_graph.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "sdb", "sdb_crime_weekday_graph.jpeg"), width = 9, height = 5.45),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere: Total Crimes by Days of the Week", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Skinker DeBaliviere: Crimes by Time of Day

```{r SDB Crime by Time of Day Graph Prep, include = FALSE }
monthCrimes20 %>%
  filter(., neighborhood == 46) %>%
  group_by(dayNight) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, "sdb", "sdb_crime_timeDay_graph.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "sdb", "sdb_crime_timeDay_graph.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere: Crimes by Time of Day", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Skinker DeBaliviere: Crimes by Day & Category

```{r SDB Crime by Category Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 46) %>%
  group_by(crimeCatName) %>%
  ggplot(., aes(weekday)) +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, "sdb", "sdb_crimeCat_weekday_graph.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "sdb", "sdb_crimeCat_weekday_graph.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Skinker DeBaliviere: Crimes by Day & Category", 
               location = ph_location_type(
                 type = "title") )-> report
```

## DeBaliviere Place: Neighborhood Detail
### Appendix 2

```{r}
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "DeBaliviere Place: Neighborhood Detail", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with("Appendix 2", location = ph_location_type(type = "subTitle")) -> report
```

## DeBaliviere Place: Time of Crimes Map

```{r DBP Day & Night Prep, include = FALSE}
dbp_dn_tm <- tm_shape(dbp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 47) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 47) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(dbp_dn_tm, file = here("results", params$year, params$month, "dbp", "dbp_day_night.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "dbp", "dbp_day_night.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place: Time of Crimes map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## DeBaliviere Place: Violent Crime Map

```{r DBP Violent Crime Map Prep, include = FALSE}
dbp_vlnt_tm <- tm_shape(dbp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 47) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 47) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "violent",
               palette = tf_cols,
               title.col = "Violent") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(dbp_vlnt_tm, file = here("results", params$year, params$month, "dbp", "dbp_vlnt.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "dbp", "dbp_vlnt.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place: Violent Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## DeBaliviere Place: Crime Density Map

```{r DBP Density Map Prep, eval = FALSE}
monthCrimes20_sf %>%
  filter(neighborhood == 47) %>%
  smooth_map(., bandwidth = 0.5, style = "pretty",
  cover = dbp) -> dbp_densities

dbp_den_tm <- tm_shape(dbp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 47) %>%
  tm_shape() +
    tm_fill(col = NA,
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(dbp_densities$polygons) +
  tm_fill(col = "level", palette = "BuPu", alpha = .60,
    title = expression("Crimes per " * km^2)) +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(dbp_den_tm, file = here("results", params$year, params$month, "dbp", "dbp_density.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "dbp", "dbp_density.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place: Crime Density Map",
               location = ph_location_type(
                 type = "title") )-> report
```

## DeBaliviere Place: Larceny Breakdown

```{r DBP Larceny Breakdown Prep, include = FALSE}
larceny %>%
  filter(., neighborhood == 47) %>%
  group_by(weekday) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> dbp_larcenies_weekDay

larceny %>%
  filter(., neighborhood == 47) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> dbp_larcenies_dayNight

larceny %>%
  filter(., neighborhood == 47) %>%
  group_by(type) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> dbp_larcenies_type

larceny %>%
  filter(., neighborhood == 47) %>%
  group_by(value) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> dbp_larcenies_value
```

```{r DBP Larceny Tables Knit, echo = FALSE}
flextable(dbp_larcenies_weekDay) %>%
  autofit() -> flex01

flextable(dbp_larcenies_dayNight) %>%
  autofit() -> flex02

flextable(dbp_larcenies_type) %>%
  autofit() -> flex03

flextable(dbp_larcenies_value) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with("DeBaliviere Place: Larceny Breakdown", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 2, flex01)%>%
  phl_with_flextable(olay = offlayout, 3, flex02)%>%
  phl_with_flextable(olay = offlayout, 4, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report
```

## DeBaliviere Place: Total Crimes by Days of the Week

```{r DBP Crime by Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 47) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> dbp_weekDay

wkdys[!(wkdys %in% dbp_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(dbp_weekDay) -> dbp_weekDay

if(test == FALSE) {
   add_row(dbp_weekDay, weekday = missing_category_days) -> dbp_weekDay
}

  ggplot(dbp_weekDay, aes(x=weekday, y=n, group = 1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, "dbp", "dbp_crime_weekday_graph.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "dbp", "dbp_crime_weekday_graph.jpeg"), width = 9, height = 5.45),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place: Total Crimes by Days of the Week", 
               location = ph_location_type(
                 type = "title") )-> report
```

## DeBaliviere Place: Crimes by Time of Day

```{r DBP Crime by Time of Day Graph Prep, include = FALSE }
monthCrimes20 %>%
  filter(., neighborhood == 47) %>%
  group_by(dayNight) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, "dbp", "dbp_crime_timeDay_graph.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "dbp", "dbp_crime_timeDay_graph.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place: Crimes by Time of Day", 
               location = ph_location_type(
                 type = "title") )-> report
```

## DeBaliviere Place: Crimes by Day & Category

```{r DBP Crime by Category Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 47) %>%
  group_by(crimeCatName) %>%
  ggplot(., aes(weekday)) +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, "dbp", "dbp_crimeCat_weekday_graph.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "dbp", "dbp_crimeCat_weekday_graph.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("DeBaliviere Place: Crimes by Day & Category", 
               location = ph_location_type(
                 type = "title") )-> report
```

## West End: Neighborhood Detail
### Appendix 3

```{r}
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "West End: Neighborhood Detail", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with("Appendix 3", location = ph_location_type(type = "subTitle")) -> report
```

## West End: Time of Crimes Map

```{r WE Day & Night Prep, include = FALSE}
we_dn_tm <- tm_shape(we_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 48) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 48) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(we_dn_tm, file = here("results", params$year, params$month, "we", "we_day_night.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "we", "we_day_night.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End: Time of Crimes Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## West End: Violent Crime Map

```{r WE Violent Crime Map Prep, include = FALSE}
we_vlnt_tm <- tm_shape(we_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 48) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 48) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "violent",
               palette = tf_cols,
               title.col = "Violent") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(we_vlnt_tm, file = here("results", params$year, params$month, "we", "we_vlnt.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "we", "we_vlnt.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End: Violent Crime Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## West End: Crime Density Map

```{r WE Density Map Prep, eval = FALSE}
monthCrimes20_sf %>%
  filter(neighborhood == 48) %>%
  smooth_map(., bandwidth = 0.5, style = "pretty",
  cover = we) -> we_densities

we_den_tm <- tm_shape(we_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 48) %>%
  tm_shape() +
    tm_fill(col = NA,
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  tm_shape(we_densities$polygons) +
  tm_fill(col = "level", palette = "BuPu", alpha = .60,
    title = expression("Crimes per " * km^2)) +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(we_den_tm, file = here("results", params$year, params$month, "we", "we_density.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "we", "we_density.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End: Crime Density", 
               location = ph_location_type(
                 type = "title") )-> report
```

## West End: Larceny Breakdown

```{r WE Larceny Breakdown Prep, include = FALSE}
larceny %>%
  filter(., neighborhood == 48) %>%
  group_by(weekday) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> we_larcenies_weekDay

larceny %>%
  filter(., neighborhood == 48) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> we_larcenies_dayNight

larceny %>%
  filter(., neighborhood == 48) %>%
  group_by(type) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> we_larcenies_type

larceny %>%
  filter(., neighborhood == 48) %>%
  group_by(value) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> we_larcenies_value
```

```{r WE Larceny Tables Knit, echo = FALSE}
flextable(we_larcenies_weekDay) %>%
  autofit() -> flex01

flextable(we_larcenies_dayNight) %>%
  autofit() -> flex02

flextable(we_larcenies_type) %>%
  autofit() -> flex03

flextable(we_larcenies_value) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with("West End: Larceny Breakdown", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 2, flex01)%>%
  phl_with_flextable(olay = offlayout, 3, flex02)%>%
  phl_with_flextable(olay = offlayout, 4, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report
```

## West End: Total Crimes by Days of the Week

```{r WE Crime by Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 48) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> we_weekDay

wkdys[!(wkdys %in% we_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(we_weekDay) -> we_weekDay

if(test == FALSE) {
   add_row(we_weekDay, weekday = missing_category_days) -> we_weekDay
}

  ggplot(we_weekDay, aes(x=weekday, y=n, group = 1)) +
    geom_line(color="blue") +
    geom_point() +
    xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, "we", "we_crime_weekday_graph.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "we", "we_crime_weekday_graph.jpeg"), width = 9, height = 5.45),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End: Total Crimes by Days of the Week", 
               location = ph_location_type(
                 type = "title") )-> report
```

## West End: Crimes by Time of Day

```{r WE Crime by Time of Day Graph Prep, include = FALSE }
monthCrimes20 %>%
  filter(., neighborhood == 48) %>%
  group_by(dayNight) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, "we", "we_crime_timeDay_graph.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "we", "we_crime_timeDay_graph.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End: Total Crimes by Days of the Week", 
               location = ph_location_type(
                 type = "title") )-> report
```

## West End: Crimes by Day & Category

```{r WE Crime by Category Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 48) %>%
  group_by(crimeCatName) %>%
  ggplot(., aes(weekday)) +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, "we", "we_crimeCat_weekday_graph.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "we", "we_crimeCat_weekday_graph.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("West End: Crimes by Day & Category", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Visitation Park: Neighborhood Detail
### Appendix 4

```{r}
report%>%
  add_slide(layout = "Title Slide", master = "Office Theme")%>%
  ph_with(value = "Visitation Park: Neighborhood Detail", location = ph_location_type(type = "ctrTitle"))%>%
  ph_with("Appendix 4", location = ph_location_type(type = "subTitle")) -> report
```

## Visitation Park: Time of Crimes Map

```{r VP Day & Night Prep, include = FALSE}
vp_dn_tm <- tm_shape(vp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 49) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 49) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "dayNight",
               palette = "-RdBu",
               title.col = "Time of Crimes") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(vp_dn_tm, file = here("results", params$year, params$month, "vp", "vp_day_night.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vp", "vp_day_night.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Visitation Park: Time of Crimes Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Visitation Park: Violent Crime Map

```{r VP Violent Crime Map Prep, include = FALSE}
vp_vlnt_tm <- tm_shape(vp_tiles) +
  tm_rgb() +
  nhoods_sf %>%
  filter(., neighborhood == 49) %>%
  tm_shape() +
    tm_fill(col = "#9ecae1",
            alpha = .5) +
    tm_borders(col = "black",
               lwd = 2,
               lty = "dashed") +
  filter(monthCrimes20_sf,
         neighborhood == 49) %>%
  tm_shape() +
    tm_bubbles(size = .25,
               col = "violent",
               palette = tf_cols,
               title.col = "Violent") +
  tm_credits("© Mapbox, © OpenStreetMap", position = c("left", "BOTTOM")) +
  tm_layout(
    frame = FALSE,
    legend.bg.color = "white",
    legend.frame=TRUE,
    legend.outside = TRUE,
    legend.position = c("right", "bottom"))

tmap_save(vp_vlnt_tm, file = here("results", params$year, params$month, "vp", "vp_vlnt.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vp", "vp_vlnt.jpeg"), width = 9, height = 5), location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Visitation Park: Time of Crimes Map", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Visitation Park: Larceny Breakdown

```{r VP Larceny Breakdown Prep, include = FALSE}
larceny %>%
  filter(., neighborhood == 49) %>%
  group_by(weekday) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Day of the Week" = weekday) -> vp_larcenies_weekDay

larceny %>%
  filter(., neighborhood == 49) %>%
  group_by(dayNight) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Time of Day" = dayNight) -> vp_larcenies_dayNight

larceny %>%
  filter(., neighborhood == 49) %>%
  group_by(type) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Type of Larceny" = type) -> vp_larcenies_type

larceny %>%
  filter(., neighborhood == 49) %>%
  group_by(value) %>%
  count() %>%
  adorn_totals(., "row", name = "Total") %>%
  rename(., "Number of Crimes" = n, "Monetary" = value) -> vp_larcenies_value
```

```{r VP Larceny Tables Knit, echo = FALSE}
flextable(vp_larcenies_weekDay) %>%
  autofit() -> flex01

flextable(vp_larcenies_dayNight) %>%
  autofit() -> flex02

flextable(vp_larcenies_type) %>%
  autofit() -> flex03

flextable(vp_larcenies_value) %>%
  autofit() -> flex04

# add to powerpoint
report%>%
  add_slide()%>%
  ph_with("Visitation Park: Larceny Breakdown", 
               location = ph_location_type(
                 type = "title"))%>%
  phl_with_flextable(olay = offlayout, 2, flex01)%>%
  phl_with_flextable(olay = offlayout, 3, flex02)%>%
  phl_with_flextable(olay = offlayout, 4, flex03)%>%
  phl_with_flextable(olay = offlayout, 5, flex04) -> report
```

## Visitation Park: Total Crimes by Days of the Week

```{r VP Crime by Weekday Graph Prep, include= FALSE}

monthCrimes20 %>%
  filter(., neighborhood == 49) %>%
  group_by(weekday, .drop = FALSE) %>%
  count() %>%
  replace(., is.na(.), 0) -> vp_weekDay

wkdys[!(wkdys %in% vp_weekDay$weekday)] -> missing_category_days
is_empty(missing_category_days) -> test

as.data.frame(vp_weekDay) -> vp_weekDay

if(test == FALSE) {
   add_row(vp_weekDay, weekday = missing_category_days) -> vp_weekDay
}

ggplot(vp_weekDay, aes(x=weekday, y=n, group = 1)) +
  geom_line(color="blue") +
  geom_point() +
  xlab("Day of Week") + ylab("Total Crimes")

ggsave(here("results", params$year, params$month, "vp", "vp_crime_weekday_graph.jpeg"), dpi = 500)

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vp", "vp_crime_weekday_graph.jpeg"), width = 9, height = 5.45),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Visitation Park: Total Crimes by Days of the Week", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Visitation Park: Crimes by Time of Day

```{r VP Crime by Time of Day Graph Prep, include = FALSE }
monthCrimes20 %>%
  filter(., neighborhood == 49) %>%
  group_by(dayNight) %>%
  count() %>%
  ggplot(., aes(x=dayNight, y=n, fill = dayNight)) +
    geom_bar(stat="identity", position=position_dodge(), colour="black") +
    xlab("Time of Day") + ylab("Total Crimes") +
    labs(fill = "Time")

ggsave(here("results", params$year, params$month, "vp", "vp_crime_timeDay_graph.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vp", "vp_crime_timeDay_graph.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Visitation Park: Crimes by Time of Day", 
               location = ph_location_type(
                 type = "title") )-> report
```

## Visitation Park: Crimes by Day & Category

```{r VP Crime by Category Weekday Graph Prep, include= FALSE}
monthCrimes20 %>%
  filter(., neighborhood == 49) %>%
  group_by(crimeCatName) %>%
  ggplot(., aes(weekday)) +
    scale_colour_manual(
    values = cols,
    aesthetics = c("colour", "fill")
    ) +
    geom_bar(aes(fill = crimeCatName), position=position_dodge(), colour="black") +
    xlab("Day of Week") + ylab("Total Crimes") +
    labs(fill = "Part 1 Crimes")

ggsave(here("results", params$year, params$month, "vp", "vp_crimeCat_weekday_graph.jpeg"), width = 9, height = 5, units = "in")

#add to powerpoint report
report%>%
  add_slide()%>%
  ph_with(external_img(here::here("results", params$year, params$month, "vp", "vp_crimeCat_weekday_graph.jpeg"), width = 9, height = 5),
          location = ph_location_type(type = "body"), use_loc_size = FALSE)%>%
  ph_with("Visitation Park: Crimes by Day & Category", 
               location = ph_location_type(
                 type = "title") )-> report
```

```{r}
# save powerpoint report
print(report, target = here::here("results", "presentations",  params$year, params$month, paste("sdbp-dbp-we-vp-", params$month, params$year, ".pptx", sep = "")))

#delete any existing sdbp-dbp-we-vp- file in the Shiny app
mydir <- "/Users/loganbogenut/Documents/GitHub/crime_interactive/crime_interactive/www/"
file.remove(file.path(mydir, dir(path = mydir, pattern = "Park_crime")))

#convert & save powerpoint as PDF to Shiny app
convert_to_pdf(path = here::here("results", "presentations",  params$year, params$month, paste("sdbp-dbp-we-vp-", params$month, params$year, ".pptx", sep = "")),
               pdf_file = sub("[.]pptx", ".pdf", paste("~/Documents/GitHub/crime_interactive/crime_interactive/www/", "Skinker DeBaliviere, DeBaliviere Place, West End, Visitation Park_crime", ".pptx", sep = "")))
```

```{r}
# This code cleans our Global Environment.

rm(list = ls())

print("Great job! The code ran all the way through. You did AMAZING!")
```
